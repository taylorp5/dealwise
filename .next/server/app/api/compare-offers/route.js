"use strict";(()=>{var e={};e.id=4122,e.ids=[4122],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},23200:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>h,patchFetch:()=>v,requestAsyncStorage:()=>d,routeModule:()=>u,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var o={};t.r(o),t.d(o,{POST:()=>l});var s=t(49303),i=t(88716),a=t(60670),n=t(87070),c=t(19692),p=t(8563);async function l(e){try{let r=await (0,c.f)(),{data:{session:t}}=await r.auth.getSession();if(!t?.user)return n.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let o=t.user.id,s=await e.json();if(!s.offers||s.offers.length<2)return n.NextResponse.json({success:!1,error:"Please provide at least 2 offers to compare"},{status:400});let i=(0,p.$)(),a=`You are an expert car buying advisor. Your job is to compare multiple dealer offers and provide clear, actionable recommendations.

CRITICAL RULES:
1. Be objective and educational - provide guidance, not financial advice
2. Focus on total cost (OTD price) when available, not just listed price
3. Consider all factors: price, dealer reputation, distance, included features
4. Highlight the best value, not necessarily the lowest price
5. Provide specific, actionable recommendations
6. Never guarantee outcomes

Your response must be a JSON object with this exact structure:
{
  "comparison": "<detailed comparison analysis in 2-3 paragraphs>",
  "bestOffer": <number - the best OTD price or listed price if OTD not available>,
  "recommendations": [<array of 3-5 specific recommendations>],
  "keyPoints": [<array of 3-5 key points to consider>]
}`,l=s.offers.map((e,r)=>`${r+1}. ${e.dealer}: $${e.price.toLocaleString()}${e.otdPrice?` (OTD: $${e.otdPrice.toLocaleString()})`:""}${e.notes?` - ${e.notes}`:""}`).join("\n"),u=`Compare these dealer offers and provide recommendations:

${l}

Provide a detailed comparison, identify the best offer, and give specific recommendations on which offer to pursue and why.

Return ONLY valid JSON, no other text.`,d=await i.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:a},{role:"user",content:u}],response_format:{type:"json_object"},temperature:.7}),m=JSON.parse(d.choices[0].message.content||"{}"),f=s.dealId;if(!f){let{data:e,error:t}=await r.from("deals").insert({user_id:o,title:"Offer Comparison"}).select().single();t?console.error("Error creating deal (continuing anyway):",t):f=e.id}if(f){let{error:e}=await r.from("analyses").insert({user_id:o,deal_id:f,analysis_type:"offer_comparison",raw_input:{offers:s.offers},ai_output:m});e&&console.error("Error saving analysis (continuing anyway):",e)}let h={success:!0,analysisId:void 0,dealId:f,data:{comparison:m.comparison||"Comparison analysis",bestOffer:m.bestOffer||Math.min(...s.offers.map(e=>e.otdPrice||e.price)),recommendations:m.recommendations||[],keyPoints:m.keyPoints||[]}};return n.NextResponse.json(h)}catch(e){return console.error("Error comparing offers:",e),n.NextResponse.json({success:!1,error:e.message||"Failed to compare offers"},{status:500})}}let u=new s.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/compare-offers/route",pathname:"/api/compare-offers",filename:"route",bundlePath:"app/api/compare-offers/route"},resolvedPagePath:"C:\\dev\\Dealership Copilot\\app\\api\\compare-offers\\route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:d,staticGenerationAsyncStorage:m,serverHooks:f}=u,h="/api/compare-offers/route";function v(){return(0,a.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}},8563:(e,r,t)=>{t.d(r,{$:()=>i});var o=t(54214);let s=null;function i(){if(!s){let e=process.env.OPENAI_API_KEY;if(!e)throw Error("OPENAI_API_KEY is not set");s=new o.ZP({apiKey:e})}return s}},19692:(e,r,t)=>{t.d(r,{$:()=>n,f:()=>c});var o=t(67721),s=t(71615);let i="https://vabikejehdmpfcyqrgrs.supabase.co",a="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q";if(!i||!a){let e=[];throw i||e.push("NEXT_PUBLIC_SUPABASE_URL"),a||e.push("NEXT_PUBLIC_SUPABASE_ANON_KEY"),Error(`[CRITICAL] Missing required Supabase environment variables: ${e.join(", ")}. These must be set in Vercel environment variables.`)}if(i.includes("placeholder")||a.includes("placeholder"))throw Error("[CRITICAL] Supabase environment variables contain placeholder values. Please set real values in Vercel environment variables.");if(i.length<10||a.length<10)throw Error("[CRITICAL] Supabase environment variables appear to be invalid (too short). Please verify they are set correctly in Vercel.");function n(){let e=(0,s.cookies)();return(0,o.createServerClient)("https://vabikejehdmpfcyqrgrs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q",{cookies:{getAll:()=>e.getAll(),setAll(r){try{r.forEach(({name:r,value:t,options:o})=>{e.set(r,t,o)})}catch(e){}}}})}let c=n}};var r=require("../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[8948,5972,7857,9702,4214],()=>t(23200));module.exports=o})();