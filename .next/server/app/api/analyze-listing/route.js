"use strict";(()=>{var e={};e.id=6410,e.ids=[6410],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},78893:e=>{e.exports=require("buffer")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},98061:e=>{e.exports=require("node:assert")},92761:e=>{e.exports=require("node:async_hooks")},72254:e=>{e.exports=require("node:buffer")},40027:e=>{e.exports=require("node:console")},6005:e=>{e.exports=require("node:crypto")},65714:e=>{e.exports=require("node:diagnostics_channel")},30604:e=>{e.exports=require("node:dns")},15673:e=>{e.exports=require("node:events")},87561:e=>{e.exports=require("node:fs")},93977:e=>{e.exports=require("node:fs/promises")},88849:e=>{e.exports=require("node:http")},42725:e=>{e.exports=require("node:http2")},87503:e=>{e.exports=require("node:net")},49411:e=>{e.exports=require("node:path")},38846:e=>{e.exports=require("node:perf_hooks")},39630:e=>{e.exports=require("node:querystring")},55467:e=>{e.exports=require("node:sqlite")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},92332:e=>{e.exports=require("node:timers")},31764:e=>{e.exports=require("node:tls")},47261:e=>{e.exports=require("node:util")},93746:e=>{e.exports=require("node:util/types")},24086:e=>{e.exports=require("node:worker_threads")},65628:e=>{e.exports=require("node:zlib")},98986:(e,t,i)=>{i.r(t),i.d(t,{originalPathname:()=>S,patchFetch:()=>R,requestAsyncStorage:()=>x,routeModule:()=>C,serverHooks:()=>T,staticGenerationAsyncStorage:()=>A});var a={};i.r(a),i.d(a,{POST:()=>k});var r=i(49303),n=i(88716),o=i(60670),s=i(87070),l=i(19692),c=i(70917);function d(e){if(!e)return;let t=parseFloat(e.replace(/[$,]/g,""));if(!isNaN(t)&&!(t<500)&&!(t>2e5))return Math.round(t)}function u(e){if(!e)return;let t=e.match(/(\d{1,3}(?:[,\s]\d{3})*)\s*(?:mi|miles?|k\s*mi)/i);if(t){let e=parseInt(t[1].replace(/[,\s]/g,""));if(!isNaN(e)&&e>=0&&e<=5e5)return e}let i=e.match(/(\d+(?:\.\d+)?)\s*k\b/i);if(i){let e=1e3*parseFloat(i[1]);if(!isNaN(e)&&e>=0&&e<=5e5)return Math.round(e)}}function m(e){if(!e)return"unknown";let t=e.toLowerCase();return t.includes("new")?"new":t.includes("certified")||t.includes("cpo")?"cpo":t.includes("used")||t.includes("pre-owned")?"used":"unknown"}function p(e){if(!e)return{};let t={},i=e.match(/\b(19|20)\d{2}\b/);if(i){let e=parseInt(i[0]);e>=1990&&e<=new Date().getFullYear()+1&&(t.year=e)}for(let i of["Toyota","Honda","Ford","Chevrolet","Chevy","Nissan","BMW","Mercedes-Benz","Mercedes","Audi","Lexus","Acura","Infiniti","Cadillac","Lincoln","Jeep","Ram","Dodge","Chrysler","GMC","Buick","Hyundai","Kia","Mazda","Subaru","Volkswagen","VW","Volvo","Porsche","Tesla","Genesis","Alfa Romeo","Jaguar","Land Rover","Mini","Mitsubishi","Fiat"])if(RegExp(`\\b${i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}\\b`,"i").test(e)){t.make="Chevy"===i?"Chevrolet":"VW"===i?"Volkswagen":i;break}if(t.make){let i=e.toLowerCase().indexOf(t.make.toLowerCase());if(-1!==i){let a=e.substring(i+t.make.length).trim().match(/^([A-Z][a-z]+(?:\s+[A-Z][a-z]+)?)/);if(a){let e=a[1].trim();["New","Used","Certified","CPO","Pre-Owned"].includes(e)||(t.model=e)}}}let a=e.match(/(?:\(([^)]+)\)|(?:Trim|Package):\s*([^,]+))/i);return a&&(t.trim=(a[1]||a[2]).trim()),t}function h(e,t){for(let i of t){let t=e(i).first();if(t.length){let e=t.text().trim();if(e)return e}}return null}async function g(e,t){let i={sourceUrl:e,sourceSite:"cars.com"},a=[];if(!t)return{...i,confidence:0,issues:["HTML content not provided"]};let r=function(e){let t={},i=e.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);if(!i)return t;for(let e of i)try{let i=e.replace(/<script[^>]*>/,"").replace(/<\/script>/,""),a=JSON.parse(i);if(!(Array.isArray(a["@type"])?a["@type"]:[a["@type"]]).some(e=>e.includes("Vehicle")||e.includes("Product")))continue;if(a.offers){for(let e of Array.isArray(a.offers)?a.offers:[a.offers])if(e.price&&!t.price){let i="string"==typeof e.price?d(e.price):e.price;i&&(t.price=i)}}if(a.brand&&!t.make&&(t.make="string"==typeof a.brand?a.brand:a.brand.name),a.name&&!t.title&&(t.title=a.name),a.vehicleIdentificationNumber&&!t.vin&&(t.vin=a.vehicleIdentificationNumber),a.mileageFromOdometer&&!t.mileage){let e="object"==typeof a.mileageFromOdometer?a.mileageFromOdometer.value:a.mileageFromOdometer;e&&(t.mileage=u(String(e)))}a.itemCondition&&!t.vehicleCondition&&(t.vehicleCondition=m(a.itemCondition))}catch(e){continue}return t}(t);Object.keys(r).length>0&&(Object.assign(i,r),a.push("json-ld"));let n=function(e){let t={};for(let i of[/window\.__NEXT_DATA__\s*=\s*({[\s\S]+?});/,/window\.__PRELOADED_STATE__\s*=\s*({[\s\S]+?});/,/__INITIAL_STATE__\s*=\s*({[\s\S]+?});/,/<script[^>]*id=["']__NEXT_DATA__["'][^>]*>([\s\S]+?)<\/script>/]){let a=e.match(i);if(a)try{let e=a[1],i=JSON.parse(e),r=(e,t)=>{if(0===t.length)return e;if(!e||"object"!=typeof e)return;let[i,...a]=t;if(Array.isArray(e))for(let i of e){let e=r(i,t);if(void 0!==e)return e}return r(e[i],a)};for(let e of[["props","pageProps","vehicle","price"],["props","pageProps","listing","price"],["vehicle","price"],["listing","price"],["price"]]){let a=r(i,e);if(a&&!t.price){let e="string"==typeof a?d(a):a;e&&(t.price=e)}}for(let e of[["props","pageProps","vehicle"],["props","pageProps","listing"],["vehicle"],["listing"]]){let a=r(i,e);if(a&&"object"==typeof a){if(a.price&&!t.price){let e="string"==typeof a.price?d(a.price):a.price;e&&(t.price=e)}if(a.year&&!t.year&&(t.year=a.year),a.make&&!t.make&&(t.make=a.make),a.model&&!t.model&&(t.model=a.model),a.trim&&!t.trim&&(t.trim=a.trim),a.mileage&&!t.mileage&&(t.mileage=u(String(a.mileage))),a.vin&&!t.vin&&(t.vin=a.vin),a.stockNumber&&!t.stockNumber&&(t.stockNumber=a.stockNumber),a.condition&&!t.vehicleCondition&&(t.vehicleCondition=m(a.condition)),a.dealer&&!t.dealerName&&(t.dealerName="string"==typeof a.dealer?a.dealer:a.dealer.name),a.location&&!t.dealerCity){if("string"==typeof a.location){let e=a.location.split(",");e[0]&&(t.dealerCity=e[0].trim()),e[1]&&(t.dealerState=e[1].trim())}else a.location.city&&(t.dealerCity=a.location.city),a.location.state&&(t.dealerState=a.location.state),a.location.zip&&(t.zip=a.location.zip)}}}}catch(e){continue}}return t}(t);if(Object.keys(n).length>0){for(let[e,t]of Object.entries(n))t&&!i[e]&&(i[e]=t);a.push("embedded-json")}let o=function(e){let t=c.zD(e),i={},a=h(t,['[data-testid="price"]',".price",".vehicle-price",'[class*="price"]',"[data-price]",'span[class*="Price"]']);a&&!i.price&&(i.price=d(a));let r=h(t,["h1",'[data-testid="title"]',".vehicle-title",'[class*="title"]',"title"]);if(r&&!i.title){i.title=r;let e=p(r);e.year&&!i.year&&(i.year=e.year),e.make&&!i.make&&(i.make=e.make),e.model&&!i.model&&(i.model=e.model),e.trim&&!i.trim&&(i.trim=e.trim)}let n=h(t,['[data-testid="mileage"]','[class*="mileage"]','[class*="odometer"]','span:contains("mi")']);n&&!i.mileage&&(i.mileage=u(n));let o=h(t,['[data-testid="condition"]','[class*="condition"]','[class*="badge"]','span:contains("New"), span:contains("Used"), span:contains("Certified")']);o&&!i.vehicleCondition&&(i.vehicleCondition=m(o));let s=h(t,['[data-testid="dealer"]','[class*="dealer"]','[class*="seller"]',".dealer-name"]);for(let e of(s&&!i.dealerName&&(i.dealerName=s),['[data-testid="location"]','[data-testid="address"]','[class*="location"]','[class*="address"]','[class*="contact"]',"footer"])){let a=h(t,[e]);if(a){let e=a.match(/\b(\d{5}(?:-\d{4})?)\b/);e&&!i.zip&&(i.zip=e[1]);let t=a.match(/([A-Za-z .'-]+),\s*([A-Z]{2})\b/);if(t&&(i.dealerCity||(i.dealerCity=t[1].trim()),i.dealerState||(i.dealerState=t[2].toUpperCase())),i.dealerCity&&i.dealerState)break}}let l=h(t,['[data-testid="vin"]','[class*="vin"]','span:contains("VIN")']);if(l&&!i.vin){let e=l.match(/\b([A-HJ-NPR-Z0-9]{17})\b/);e&&(i.vin=e[1])}return i}(t);for(let[e,t]of Object.entries(o))t&&!i[e]&&(i[e]=t);Object.keys(o).length>0&&a.push("dom");let s=function(e){let t={};if(!t.price){let i=e.match(/\$([0-9][0-9,]+)/g);if(i){let e=i.map(e=>d(e)).filter(e=>void 0!==e);e.length>0&&(t.price=Math.max(...e))}}if(!t.mileage){let i=e.match(/([0-9][0-9,]+)\s*mi\b/i);i&&(t.mileage=u(i[0]))}if(!t.vin){let i=e.match(/\b([A-HJ-NPR-Z0-9]{17})\b/);i&&(t.vin=i[1])}return t}(t);for(let[e,t]of Object.entries(s))t&&!i[e]&&(i[e]=t);Object.keys(s).length>0&&a.push("regex");let{confidence:l,issues:g}=function(e,t){let i=0,a=[];return e.price?e.price>=500&&e.price<=2e5?i+=.25:a.push("Price out of reasonable bounds"):a.push("Price missing"),e.year&&e.make&&e.model?i+=.2:(e.year||a.push("Year missing"),e.make||a.push("Make missing"),e.model||a.push("Model missing")),"used"===e.vehicleCondition||"cpo"===e.vehicleCondition?e.mileage?i+=.15:a.push("Mileage missing for used vehicle"):e.mileage&&(i+=.1),e.vehicleCondition&&"unknown"!==e.vehicleCondition?i+=.1:a.push("Condition unknown"),(e.dealerName||e.dealerCity||e.dealerState)&&(i+=.1),t.includes("json-ld")||t.includes("embedded-json")?i+=.2:t.includes("dom")&&(i+=.1),{confidence:i=Math.min(i,1),issues:a}}(i,a);return{...i,confidence:l,issues:g,raw:{strategies:a,jsonLdData:r,embeddedData:n,domData:o,regexData:s}}}async function f(e,t){let i={sourceUrl:e,sourceSite:"other"},a=[],r=[],n=[],o=function(e){let t=e.toLowerCase();return t.includes("dealerinspire")||t.includes("window.__nuxt__")||t.includes("data-nuxt")||t.includes("nuxt-dealer")?"dealerinspire":t.includes("dealeron")||t.includes("inventorysearch")||t.includes("ds-vehicle")||t.includes("dealeron.com")?"dealeron":t.includes("cdkglobal")||t.includes("oneclick")||t.includes("digitalretail")||t.includes("cdk.com")?"cdk":t.includes("dealer.com")||t.includes("dealertrack")||t.includes("dealercore")||t.includes("dealer.com/")?"dealercom":t.includes("vauto")||t.includes("vauto.com")||t.includes("vin-solutions")?"vauto":t.includes("autotrader.com")&&(t.includes("atcms")||t.includes("at-inventory"))?"autotrader_cms":t.includes("cargurus.com")&&(t.includes("cg-embed")||t.includes("cargurus-embed"))?"car_gurus_embed":"unknown"}(t||""),s={},l={},h={},g={},f={};if(!t)return{...i,confidence:0,issues:["HTML content not provided"]};let y=t.toLowerCase();if(["captcha","access denied","403","blocked","robot","bot detection"].some(e=>y.includes(e)))return{...i,blocked:!0,confidence:0,issues:["Page appears to be blocked (captcha/anti-bot detected)"]};Object.keys(s=function(e){let t={},i=e.match(/<script[^>]*type=["']application\/ld\+json["'][^>]*>([\s\S]*?)<\/script>/gi);if(!i)return t;for(let e of i)try{let i=e.replace(/<script[^>]*>/,"").replace(/<\/script>/,""),a=JSON.parse(i);if(!(Array.isArray(a["@type"])?a["@type"]:[a["@type"]]).some(e=>e&&"string"==typeof e&&(e.includes("Vehicle")||e.includes("Product")||e.includes("Car")||e.includes("Auto"))))continue;if(a.offers){for(let e of Array.isArray(a.offers)?a.offers:[a.offers])if(e.price&&!t.price){let i="string"==typeof e.price?d(e.price):e.price;i&&(t.price=i)}}if(a.brand&&!t.make&&(t.make="string"==typeof a.brand?a.brand:a.brand.name),a.name&&!t.title){t.title=a.name;let e=p(a.name);e.year&&!t.year&&(t.year=e.year),e.make&&!t.make&&(t.make=e.make),e.model&&!t.model&&(t.model=e.model),e.trim&&!t.trim&&(t.trim=e.trim)}if(a.vehicleIdentificationNumber&&!t.vin&&(t.vin=a.vehicleIdentificationNumber),a.vin&&!t.vin&&(t.vin=a.vin),a.mileageFromOdometer&&!t.mileage){let e="object"==typeof a.mileageFromOdometer?a.mileageFromOdometer.value:a.mileageFromOdometer;e&&(t.mileage=u(String(e)))}if(a.itemCondition&&!t.vehicleCondition){let e="string"==typeof a.itemCondition?a.itemCondition:a.itemCondition.name||a.itemCondition["@type"];t.vehicleCondition=m(e)}if(a.seller||a.provider){let e=a.seller||a.provider;e.name&&!t.dealerName&&(t.dealerName=e.name),e.address&&(e.address.addressLocality&&!t.dealerCity&&(t.dealerCity=e.address.addressLocality),e.address.addressRegion&&!t.dealerState&&(t.dealerState=e.address.addressRegion),e.address.postalCode&&!t.zip&&(t.zip=e.address.postalCode))}}catch(e){continue}return t}(t)).length>0&&(Object.assign(i,s),a.push("json-ld"));let b=function(e){let t={};for(let i of[/window\.__NEXT_DATA__\s*=\s*({[\s\S]+?});/,/window\.__NUXT__\s*=\s*({[\s\S]+?});/,/window\.__INITIAL_STATE__\s*=\s*({[\s\S]+?});/,/window\.__PRELOADED_STATE__\s*=\s*({[\s\S]+?});/,/preloadedState\s*=\s*({[\s\S]+?});/,/<script[^>]*id=["']__NEXT_DATA__["'][^>]*>([\s\S]+?)<\/script>/]){let a=e.match(i);if(a)try{let e=a[1],i=JSON.parse(e),r=(e,t)=>{if(0===t.length)return e;if(!e||"object"!=typeof e)return;let[i,...a]=t;if(Array.isArray(e))for(let i of e){let e=r(i,t);if(void 0!==e)return e}if(void 0!==e[i])return r(e[i],a)};for(let e of[["props","pageProps","vehicle"],["props","pageProps","listing"],["props","pageProps","inventory"],["vehicle"],["listing"],["inventory"],["data","vehicle"],["data","listing"]]){let a=r(i,e);if(a&&"object"==typeof a){for(let e of["price","internetPrice","salePrice","yourPrice","finalPrice","listPrice","askingPrice"])if(a[e]&&!t.price){let i=d(String(a[e]));i&&(t.price=i)}if(a.mileage&&!t.mileage&&(t.mileage=u(String(a.mileage))),a.odometer&&!t.mileage&&(t.mileage=u(String(a.odometer))),a.vin&&!t.vin&&(t.vin=String(a.vin).toUpperCase()),a.stock&&!t.stockNumber&&(t.stockNumber=String(a.stock)),a.stockNumber&&!t.stockNumber&&(t.stockNumber=String(a.stockNumber)),a.condition&&!t.vehicleCondition&&(t.vehicleCondition=m(String(a.condition))),void 0===a.isNew||t.vehicleCondition||(t.vehicleCondition=a.isNew?"new":"used"),a.certified&&!t.vehicleCondition&&(t.vehicleCondition="cpo"),a.year&&!t.year&&(t.year=parseInt(String(a.year))),a.make&&!t.make&&(t.make=String(a.make)),a.model&&!t.model&&(t.model=String(a.model)),a.trim&&!t.trim&&(t.trim=String(a.trim)),a.title&&!t.title){t.title=String(a.title);let e=p(t.title);e.year&&!t.year&&(t.year=e.year),e.make&&!t.make&&(t.make=e.make),e.model&&!t.model&&(t.model=e.model),e.trim&&!t.trim&&(t.trim=e.trim)}a.dealer&&("string"==typeof a.dealer?t.dealerName||(t.dealerName=a.dealer):(a.dealer.name&&!t.dealerName&&(t.dealerName=a.dealer.name),a.dealer.city&&!t.dealerCity&&(t.dealerCity=a.dealer.city),a.dealer.state&&!t.dealerState&&(t.dealerState=a.dealer.state),a.dealer.zip&&!t.zip&&(t.zip=a.dealer.zip)))}}}catch(e){continue}}return t}(t);if(l=b,Object.keys(b).length>0){for(let[e,t]of Object.entries(b))t&&!i[e]&&(i[e]=t);a.push("embedded-json")}let w=function(e){let t=c.zD(e),i={},a=t('meta[property="og:title"]').attr("content");if(a&&!i.title){i.title=a;let e=p(a);e.year&&!i.year&&(i.year=e.year),e.make&&!i.make&&(i.make=e.make),e.model&&!i.model&&(i.model=e.model),e.trim&&!i.trim&&(i.trim=e.trim)}let r=t('meta[property="product:price:amount"]').attr("content");r&&!i.price&&(i.price=d(r));let n=t('meta[name="description"]').attr("content")||t('meta[property="og:description"]').attr("content");return n&&(i.mileage||(i.mileage=u(n)),i.vehicleCondition||(i.vehicleCondition=m(n))),i}(t);for(let[e,t]of(h=w,Object.entries(w)))t&&!i[e]&&(i[e]=t);if(Object.keys(w).length>0&&(a.push("meta-tags"),w.price)){let e=c.zD(t)('meta[property="product:price:amount"]').attr("content");if(e){let t=function(e,t,i=80){let a=[];for(let r of[...e.matchAll(/\$[\d,]+/g)]){let n=r[0],o=parseFloat(n.replace(/[$,]/g,""));if(isNaN(o)||o<500||o>25e4)continue;let s=r.index||0,l=Math.max(0,s-i),c=Math.min(e.length,s+n.length+i),d=e.substring(l,c).trim(),u=d.toLowerCase(),m="price";u.includes("internet price")||u.includes("e-price")?m="Internet Price":u.includes("sale price")||u.includes("our price")?m="Sale Price":u.includes("dealer price")?m="Dealer Price":u.includes("final price")||u.includes("today's price")?m="Final Price":u.includes("msrp")||u.includes("sticker")||u.includes("retail")?m="MSRP":u.includes("list price")&&(m="List Price");let p=u.includes("/mo")||u.includes("per month")||u.includes("monthly")||u.includes("biweekly")||u.includes("lease")||u.includes("payment"),h=u.includes("msrp")||u.includes("sticker")||u.includes("retail")||u.includes("manufacturer"),g=u.includes("save")||u.includes("discount")||u.includes("off")||u.includes("reduced"),f=u.includes("with trade")||u.includes("with approved")||u.includes("after incentives")||u.includes("starting at")||u.includes("from")||u.includes("as low as")||u.includes("est.")||u.includes("estimate")||u.includes("calculator");a.push({value:o,label:m,source:t,context:d,score:0,isLikelyMonthlyPayment:p,isLikelyMsrp:h,isLikelyDiscount:g,isLikelyConditional:f})}return a}(e,"meta");r.push(...t.map(e=>({price:e.value,label:e.label,context:e.context})))}}let v=function(e){let t=c.zD(e),i={},a=[],r=["price","internet price","sale price","our price","dealer price","msrp","list price"],n=["internet price","sale price","our price","dealer price"];if(t("*").each((e,i)=>{let o=t(i).text(),s=o.match(/\$[\d,]+/g);if(s){let e=o.substring(0,200).toLowerCase();if(r.some(t=>e.includes(t)))for(let t of s){let i=d(t);if(i&&i>=500&&i<=25e4){let t=n.find(t=>e.includes(t))||r.find(t=>e.includes(t))||"price";a.push({price:i,label:t,context:o.substring(0,100)})}}}}),a.length>0){let e=a.find(e=>n.some(t=>e.label.toLowerCase().includes(t)));if(e)i.price=e.price;else{let e=a.sort((e,t)=>e.price-t.price);i.price=e[0].price}i.priceCandidates=a}for(let e of(t("*").each((e,a)=>{let r=t(a).text();if(r.toLowerCase().includes("mileage")||r.toLowerCase().includes("odometer")){let e=u(r);e&&!i.mileage&&(i.mileage=e)}}),t("*").each((e,a)=>{let r=t(a).text().toLowerCase();!i.vehicleCondition&&(!r.includes("new")||r.includes("used")||r.includes("pre-owned")?r.includes("certified")||r.includes("cpo")?i.vehicleCondition="cpo":(r.includes("used")||r.includes("pre-owned"))&&(i.vehicleCondition="used"):i.vehicleCondition="new")}),t("*").each((e,a)=>{let r=t(a).text().match(/\b([A-HJ-NPR-Z0-9]{17})\b/);r&&!i.vin&&(i.vin=r[1].toUpperCase())}),["h1","h2",'[class*="title"]','[class*="heading"]'])){let a=t(e).first().text().trim();if(a&&a.length>10&&!i.title){i.title=a;let e=p(a);e.year&&!i.year&&(i.year=e.year),e.make&&!i.make&&(i.make=e.make),e.model&&!i.model&&(i.model=e.model),e.trim&&!i.trim&&(i.trim=e.trim);break}}if(t("dl, table").each((e,a)=>{let r=t(a);r.text().toLowerCase(),r.find("dt, th, td").each((e,a)=>{let r=t(a).text().toLowerCase(),n=t(a).next().text();if(r.includes("price")&&!i.price){let e=d(n);e&&(i.price=e)}if(r.includes("mileage")&&!i.mileage&&(i.mileage=u(n)),r.includes("vin")&&!i.vin){let e=n.match(/\b([A-HJ-NPR-Z0-9]{17})\b/);e&&(i.vin=e[1].toUpperCase())}if(r.includes("stock")&&!i.stockNumber&&(i.stockNumber=n.trim()),r.includes("dealer")&&!i.dealerName&&(i.dealerName=n.trim()),r.includes("location")||r.includes("address")){let e=n.trim().match(/([A-Za-z .'-]+),\s*([A-Z]{2})\b/);e&&!i.dealerCity&&(i.dealerCity=e[1].trim(),i.dealerState=e[2].toUpperCase())}})}),!i.dealerName)for(let e of['[class*="dealer"]','[class*="dealership"]','[id*="dealer"]','header [class*="name"]',".dealer-name",".dealership-name","h1","h2","h3"]){let a=t(e).first().text().trim();if(a&&a.length>3&&a.length<100){let e=a.toLowerCase(),t=["toyota","honda","ford","chevrolet","nissan","hyundai","kia","mazda","subaru","jeep","ram","dodge","chrysler","gmc","buick","cadillac","lexus","acura","infiniti","bmw","mercedes","audi","volkswagen","volvo","porsche","tesla"].some(t=>e.includes(t)),r=e.includes("dealer")||e.includes("dealership")||e.includes("auto")||e.includes("motors");if(t||r){let e=a.replace(/\s+(dealer|dealership|auto|automotive|motors)$/i,"").trim();if(e.length>=3&&e.length<=100){i.dealerName=e;break}}}}if(!i.dealerCity||!i.dealerState)for(let e of['[class*="address"]','[class*="location"]','[class*="contact"]',"footer",'[itemprop="address"]']){let a=t(e).text(),r=a.match(/\b(\d{5}(?:-\d{4})?)\b/);r&&!i.zip&&(i.zip=r[1]);let n=a.match(/([A-Za-z .'-]+),\s*([A-Z]{2})\b/);if(n&&(i.dealerCity||(i.dealerCity=n[1].trim()),i.dealerState||(i.dealerState=n[2].toUpperCase())),i.dealerCity&&i.dealerState)break}return i}(t);for(let[e,t]of(g=v,v.priceCandidates&&(r=v.priceCandidates,delete v.priceCandidates),v.mileageCandidates&&(n=v.mileageCandidates,delete v.mileageCandidates),Object.entries(v)))t&&!i[e]&&(i[e]=t);if(Object.keys(v).length>0&&a.push("dom"),!i.price){let e=function(e){let t={};if(!t.vin){let i=e.match(/\b([A-HJ-NPR-Z0-9]{17})\b/);i&&(t.vin=i[1].toUpperCase())}if(!t.mileage){let i=e.match(/(\d{1,3}(?:[,\s]\d{3})*)\s*(?:mi|miles?)/i);i&&(t.mileage=u(i[0]))}if(!t.price){let i=e.match(/\$[\d,]+/g);if(i){let a=i.map(e=>d(e)).filter(e=>void 0!==e&&e>=500&&e<=25e4);if(a.length>0){e.toLowerCase();let i=a.filter(t=>{let i=`$${t.toLocaleString()}`,a=e.indexOf(i);if(-1===a)return!1;let r=e.substring(Math.max(0,a-100),a+100).toLowerCase();return r.includes("internet")||r.includes("our")||r.includes("sale")});t.price=i.length>0?Math.min(...i):Math.min(...a)}}}return t}(t);for(let[t,a]of(f=e,Object.entries(e)))a&&!i[t]&&(i[t]=a);Object.keys(e).length>0&&a.push("regex")}let{confidence:k,issues:C}=function(e,t,i){let a=0,r=[];if(e.price){if(e.price>=500&&e.price<=25e4?a+=.3:r.push(`Price $${e.price.toLocaleString()} is outside normal range (500-250000)`),i&&i.length>1){let e=i.map(e=>e.price),t=Math.min(...e),n=Math.max(...e);n/t>1.5&&(r.push(`Multiple price candidates found ($${t.toLocaleString()} - $${n.toLocaleString()})`),a-=.1)}}else r.push("Price missing");return e.year&&e.make&&e.model?a+=.2:(e.year||r.push("Year missing"),e.make||r.push("Make missing"),e.model||r.push("Model missing")),"used"===e.vehicleCondition||"cpo"===e.vehicleCondition?e.mileage?e.mileage>=0&&e.mileage<=4e5?a+=.15:r.push(`Mileage ${e.mileage.toLocaleString()} is outside normal range`):r.push("Mileage missing for used vehicle"):e.mileage&&(a+=.1),e.vehicleCondition&&"unknown"!==e.vehicleCondition?a+=.1:r.push("Condition unknown"),(e.vin||e.stockNumber)&&(a+=.1),(e.dealerName||e.dealerCity||e.dealerState)&&(a+=.05),t.includes("json-ld")||t.includes("embedded-json")?a+=.15:t.includes("dom")?a+=.05:t.includes("regex")&&(a-=.1,r.push("Low confidence extraction (regex fallback only)")),{confidence:a=Math.max(0,Math.min(a,1)),issues:r}}(i,a,r),x=[...C];return{...i,confidence:k,issues:x,raw:{strategies:a,priceCandidates:r.slice(0,5),mileageCandidates:n.slice(0,3),platform:o,jsonLdData:s,embeddedData:l,metaData:h,domData:g,regexData:f}}}async function y(e,t){let i;try{i=new URL(e).hostname.replace(/^www\./,"").toLowerCase().includes("cars.com")?await g(e,t):await f(e,t)}catch(a){console.warn("Failed to parse URL, using generic extractor:",a),i=await f(e,t)}if(i.sourceUrl||(i.sourceUrl=e),!i.sourceSite)try{let t=new URL(e).hostname.replace(/^www\./,"").toLowerCase();t.includes("cars.com")?i.sourceSite="cars.com":t.includes("autotrader.com")?i.sourceSite="autotrader.com":t.includes("cargurus.com")?i.sourceSite="cargurus.com":i.sourceSite="other"}catch{i.sourceSite="other"}return i}var b=i(74918),w=i(54214);if(!process.env.OPENAI_API_KEY)throw Error("OPENAI_API_KEY is not set");let v=new w.ZP({apiKey:process.env.OPENAI_API_KEY});async function k(e){try{let t,a;let r=await (0,l.f)(),n=e.headers.get("authorization"),o=null;if(n?.startsWith("Bearer ")){let e=n.replace("Bearer ",""),{data:{user:t}}=await r.auth.getUser(e);t&&(o=t.id)}if(!o){let{data:{session:e}}=await r.auth.getSession();e?.user&&(o=e.user.id)}if(!o)return s.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let c=await e.json();if(!c.listingUrl)return s.NextResponse.json({success:!1,error:"Missing listingUrl"},{status:400});let d=c.listingUrl,u="manual-paste"===d||"manual-entry"===d,m={},p=null,h=!1;if(c.confirmedData||u){let e=c.confirmedData||{};m={...m,...e,state:e.dealerState||e.state||m.state},p={sourceUrl:d,sourceSite:u?"manual":"other",...e,confidence:1,issues:[]},h=!1}else if(u)u&&!c.confirmedData&&(p={sourceUrl:d,sourceSite:"manual",blocked:!1,confidence:1,issues:[]},h=!1);else{try{let t=await fetch(`${e.nextUrl.origin}/api/fetch-listing?url=${encodeURIComponent(d)}`);if(!t.ok){let e=await t.text().catch(()=>"");h=!0;let i=new URL(d).hostname.replace(/^www\./,"");(p={sourceUrl:d,sourceSite:i.includes("cars.com")?"cars.com":"other",blocked:!0,confidence:0,issues:[`Fetch failed: HTTP ${t.status}`]}).fetchInfo={finalUrl:d,fetchStatus:t.status,pageTitle:null,errorMessage:`HTTP ${t.status}: ${e.slice(0,200)}`,errorType:"http_error",blockReason:"http_error",contentType:null,contentLength:null};let a=p,r={sourceUrl:d,finalUrl:d,pageTitle:null,fetchStatus:t.status,blocked:!0,errorType:"http_error",errorMessage:`HTTP ${t.status}: ${e.slice(0,200)}`,blockReason:"http_error",platformDetected:"unknown",extractionStrategyUsed:"none",confidence:0,issues:a.issues||["Fetch failed"],priceCandidates:[],mileageCandidates:[],fetchDebug:{attemptedHeaders:["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"],timeoutMs:12e3}};return s.NextResponse.json({success:!0,data:null,dealPlan:null,extractionResult:a,diagnostics:r,extractedListing:a})}let i=await t.json(),a=i.fetchStatus??i.status??-1,r=i.html&&i.html.trim().length>0;if(!i.blocked&&r&&i.success&&-1!==a){if(r){(p=await y(d,i.html))&&(p.fetchInfo={finalUrl:i.finalUrl||d,fetchStatus:i.fetchStatus??i.status??-1,status:i.fetchStatus??i.status??-1,contentType:i.contentType,contentLength:i.contentLength,pageTitle:i.pageTitle??null,pagePreview:i.pagePreview}),m={price:p.price,year:p.year,make:p.make,model:p.model,trim:p.trim,mileage:p.mileage,vehicleCondition:p.vehicleCondition,vin:p.vin,dealerName:p.dealerName,dealerCity:p.dealerCity,dealerState:p.dealerState,zip:p.zip,state:p.dealerState,location:p.dealerCity?`${p.dealerCity}, ${p.dealerState}`:void 0};let e={sourceUrl:d,finalUrl:i.finalUrl||d,pageTitle:i.pageTitle??null,fetchStatus:i.fetchStatus??i.status??-1,blocked:i.blocked||!1,errorType:i.errorType||void 0,errorMessage:i.errorMessage||i.error||void 0,blockReason:i.blockReason,contentType:i.contentType,contentLength:i.contentLength,fetchDebug:{contentType:i.contentType,contentLength:i.contentLength,attemptedHeaders:["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"],timeoutMs:12e3},platformDetected:p.raw?.platform||"unknown",extractionStrategyUsed:p.raw?.strategies?.[0]||"unknown",confidence:p.confidence||0,issues:p.issues||[],priceCandidates:(p.raw?.priceCandidates||[]).slice(0,5).map(e=>({value:e.value||e.price,label:e.label||"Unknown",source:e.source||"unknown",context:e.context||"",score:e.score||0,flags:{isMsrp:e.isLikelyMsrp||!1,isMonthlyPayment:e.isLikelyMonthlyPayment||!1,isConditional:e.isLikelyConditional||!1}})),mileageCandidates:(p.raw?.mileageCandidates||[]).slice(0,5).map(e=>({value:e.value,source:"dom",context:e.context||"",score:e.score||0}))};p.diagnostics=e}}else{h=!0;let e=new URL(d).hostname.replace(/^www\./,""),t=i.blockReason||"unknown",r=i.errorMessage||i.error||"Access blocked by website",n=i.errorType||"unknown";(p={sourceUrl:d,sourceSite:e.includes("cars.com")?"cars.com":"other",blocked:!0,confidence:0,issues:[`Fetch blocked: ${r} (${t}, status: ${a})`]}).fetchInfo={finalUrl:i.finalUrl||d,fetchStatus:a,status:a,pageTitle:i.pageTitle||null,errorMessage:r,errorType:n,blockReason:t,contentType:i.contentType,contentLength:i.contentLength,attemptedHeaders:["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"]}}}catch(t){console.warn("Failed to fetch/extract listing:",t),h=!0;let e=new URL(d).hostname.replace(/^www\./,"");(p={sourceUrl:d,sourceSite:e.includes("cars.com")?"cars.com":"other",blocked:!0,confidence:0,issues:[`Fetch error: ${t?.message||String(t)}`]}).fetchInfo={finalUrl:d,fetchStatus:-1,pageTitle:null,errorMessage:t?.message||String(t)||"Unknown fetch error",errorType:"unknown",blockReason:"fetch_exception",contentType:null,contentLength:null}}if(!h&&!u&&!m.price&&!m.year){let e=function(e){let t={};try{let i=new URL(e),a=i.hostname.toLowerCase(),r=i.pathname,n=i.searchParams;if(a.includes("cars.com"))t.dealer=function(e){let t=e.match(/\/dealers\/([^\/]+)/i);if(t)return t[1].replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase())}(e);else if(a.includes("autotrader.com"))t.dealer=function(e){let t=e.match(/\/dealer\/([^\/]+)/i);if(t)return t[1].replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase())}(e);else if(a.includes("cargurus.com"))t.dealer=function(e){let t=e.match(/\/dealer\/([^\/]+)/i);if(t)return t[1].replace(/-/g," ").replace(/\b\w/g,e=>e.toUpperCase())}(e);else{let e=a.match(/([^.]+)\.(com|net|org|us)/);e&&(t.dealer=e[1].replace(/^www\./,""))}let o=r.match(/\/(?:vehicles?|inventory|used|new|car)\/.*?(\d{4})[-\/]([a-z]+)[-\/]([a-z-]+)/i);if(o){let e=parseInt(o[1]);e>=1990&&e<=new Date().getFullYear()+1&&(t.year=e),o[2]&&(t.make=o[2].charAt(0).toUpperCase()+o[2].slice(1)),o[3]&&(t.model=o[3].split("-").slice(0,3).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "))}let s=r.match(/\/(?:used|new|inventory)\/(\d{4})\/([a-z]+)\/([a-z-]+)/i);if(s&&!t.year){let e=parseInt(s[1]);e>=1990&&e<=new Date().getFullYear()+1&&(t.year=e),s[2]&&!t.make&&(t.make=s[2].charAt(0).toUpperCase()+s[2].slice(1)),s[3]&&!t.model&&(t.model=s[3].split("-").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "))}if(!t.year||!t.make){let e=r.match(/^\/(\d{4})[-\/]([a-z]+)(?:[-\/]([a-z-]+))?/i);if(e){if(!t.year){let i=parseInt(e[1]);i>=1990&&i<=new Date().getFullYear()+1&&(t.year=i)}!t.make&&e[2]&&(t.make=e[2].charAt(0).toUpperCase()+e[2].slice(1)),!t.model&&e[3]&&(t.model=e[3].split("-").slice(0,2).map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "))}}for(let e of["price","listPrice","list_price","salePrice","sale_price","cost","amount"]){let i=n.get(e);if(i){let e=parseInt(i.replace(/[$,]/g,""));if(e>=5e3&&e<=2e5){t.price=e;break}}}if(!t.price){let i=e.match(/[\/\-](?:price[-\/]?)?\$?(\d{4,6})(?:[\/\?]|$)/i);if(i){let e=parseInt(i[1]);e>=5e3&&e<=2e5&&(t.price=e)}}if(!t.price){let i=e.match(/\$(\d{4,6})|[-_](\d{5,6})[-_]/);if(i){let e=parseInt(i[1]||i[2]);e>=5e3&&e<=2e5&&e<1990&&(t.price=e)}}let l=e.match(/(\d{1,3}[,\.]?\d{3})\s*(?:miles?|mi|k\s*miles?)/i);if(l){let e=parseInt(l[1].replace(/[,\.]/g,""));e>=0&&e<=5e5&&(t.mileage=e)}let c=e.match(/\b([A-HJ-NPR-Z0-9]{17})\b/i);c&&(t.vin=c[1].toUpperCase());let d=e.match(/\b([A-Z]{2})\b/);if(d){let e=d[1];["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"].includes(e)&&(t.state=e)}let u=e.match(/([a-z]+)[-\/]([a-z]{2})\b/i);if(u&&!t.state){let e=u[2].toUpperCase();["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"].includes(e)&&(t.state=e,t.location=u[1].charAt(0).toUpperCase()+u[1].slice(1)+", "+e)}}catch(e){console.warn("Failed to parse URL:",e)}if(!t.price){let i=e.match(/\$?(\d{4,6})\b/);if(i){let e=parseInt(i[1]);e>=5e3&&e<2e5&&(t.price=e)}}return t}(d);m={price:e.price||m.price,year:e.year||m.year,make:e.make||m.make,model:e.model||m.model,mileage:e.mileage||m.mileage,location:e.location||m.location,state:e.state||m.state}}}if(h&&c.confirmedData,h&&!c.confirmedData&&!u){let e=p?{...p,sourceUrl:p.sourceUrl||d}:{sourceUrl:d,sourceSite:"other",blocked:!0,confidence:0,issues:["Could not read this website automatically"]},t=p?.fetchInfo||{},i={sourceUrl:d,finalUrl:t?.finalUrl||d,pageTitle:t?.pageTitle??null,fetchStatus:t?.fetchStatus??t?.status??-1,blocked:!0,errorType:t?.errorType,errorMessage:t?.errorMessage,blockReason:t?.blockReason,contentType:t?.contentType,contentLength:t?.contentLength,fetchDebug:{contentType:t?.contentType,contentLength:t?.contentLength,attemptedHeaders:t?.attemptedHeaders||["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"],timeoutMs:12e3},platformDetected:"unknown",extractionStrategyUsed:"none",confidence:0,issues:e.issues||["Could not read this website automatically"],priceCandidates:[],mileageCandidates:[]};return s.NextResponse.json({success:!0,requiresUserInput:!0,data:null,dealPlan:null,extractionResult:e,diagnostics:i,extractedListing:e})}if(!h&&p&&void 0!==p.confidence&&p.confidence<.3&&!c.confirmedData){let e={...p,sourceUrl:p.sourceUrl||d},t=p?.fetchInfo||{},i={sourceUrl:d,finalUrl:t?.finalUrl||d,pageTitle:t?.pageTitle??null,fetchStatus:t?.fetchStatus??t?.status??-1,blocked:!1,platformDetected:p.raw?.platform||"unknown",extractionStrategyUsed:p.raw?.strategies?.[0]||"unknown",confidence:p.confidence||0,issues:p.issues||["Low confidence extraction - please review"],priceCandidates:(p.raw?.priceCandidates||[]).slice(0,5),mileageCandidates:(p.raw?.mileageCandidates||[]).slice(0,5)};return s.NextResponse.json({success:!0,requiresUserInput:!0,data:null,dealPlan:null,extractionResult:e,diagnostics:i,extractedListing:e})}let g=c.registrationState,f=c.registrationZip,w={stateBaseRate:6.5,combinedRateRange:{low:6,high:7},confidence:"low",source:"state_estimate",provider:"fallback",disclaimer:"Registration location not provided. Using default tax rate range. Please provide registration state and ZIP for accurate rates."};if(g)try{w=await (0,b.A)(g,f)}catch(a){console.warn("Tax rate lookup failed:",a);let{getTaxRateForState:e}=i(93950),t=e(g)||6.5;w={stateBaseRate:t,combinedRateRange:{low:t,high:t+2.5},confidence:"low",source:"state_estimate",provider:"fallback",disclaimer:"Tax rate lookup failed. Using state base rate estimate. Please verify with dealer itemization."}}let k=`You are an expert car buying advisor that analyzes vehicle listings and creates actionable "Deal Plans" for buyers.

Your job is to transform a listing URL and basic vehicle information into a structured, decision-grade report with SPECIFIC DOLLAR AMOUNTS (not ranges like "3-7%").

CRITICAL RULES:
- Always provide EXACT dollar amounts for all targets
- Compute fair price, opening offer, acceptable deal, and walk-away ceiling
- Use reasonable heuristics: if comps exist, use midpoint; if only asking price, use conservative bands (fair = asking - 3%, opening = asking - 6%, acceptable = asking - 4%)
- Adjust for mileage/year if available (higher mileage â†’ lower fair price)
- Label estimates as "est." when uncertain
- Provide leverage scores (0-100) for each factor
- Generate specific counter-scripts for dealer tactics
- Create listing-specific scripts with actual dollar amounts filled in
- Keep all advice educational and avoid guarantees

OUTPUT FORMAT:
You must return valid JSON matching this structure:
{
  "targets": {
    "askingPrice": number,
    "estimatedFairPrice": number,
    "strongOpeningOffer": number,
    "acceptableDealPrice": number,
    "walkAwayOTDCeiling": number,
    "percentRange": "string (optional, e.g., '3-7% below asking')",
    "estimationMethod": "string (optional, how we estimated)"
  },
  "leverage": {
    "points": [
      {
        "factor": "string (e.g., 'Position in comp range')",
        "score": number (0-100),
        "strength": "high|medium|low",
        "explanation": "string"
      }
    ],
    "bestAngles": ["string", "string", "string"] (top 2-3)
  },
  "otdEstimate": {
    "assumptions": {
      "taxRate": { "range": { "low": number, "high": number } },
      "docFee": { "range": { "low": number, "high": number } },
      "registrationTitle": { "range": { "low": number, "high": number } },
      "dealerAddOns": { "value": 0, "riskBand": { "low": 0, "high": 1500 } }
    },
    "expectedOTD": { "low": number, "expected": number, "high": number },
    "warningThreshold": number,
    "checklist": ["string", "string"]
  },
  "tactics": [
    {
      "tactic": "string",
      "likelihood": "high|medium|low",
      "counter": "string (1-2 sentences)"
    }
  ],
  "scripts": [
    {
      "title": "string",
      "text": "string (with actual dollar amounts)"
    }
  ],
  "nextMoves": {
    "copilotLink": {
      "vehiclePrice": "string",
      "desiredOTD": "string",
      "stage": "initial_outreach",
      "goal": "get_otd",
      "carContext": "string"
    },
    "otdBuilderLink": {
      "price": "string"
    },
    "comparisonLink": {
      "dealer": "string",
      "price": number,
      "otdLow": number,
      "otdHigh": number
    }
  }
}

For OTD calculations:
- Tax rate: The backend will provide tax rate assumptions based on buyer registration location. Use the provided taxRate.value or taxRate.range in your calculations.
- Use $299-$699 doc fee range if state unknown
- Use $200-$600 registration/title range
- Dealer add-ons: $0 default, but show $0-$1,500 risk band
- Warning threshold: expected OTD + 5-10% (must be within \xb130% of expected OTD, otherwise omit)
- Formula: OTD = vehiclePrice + (vehiclePrice * taxRateDecimal) + fees + addOns
- IMPORTANT: Do NOT guess or estimate tax rates. Use only the taxRate values provided in the assumptions.`,C=function(e,t,i){let a=[];t?.price&&a.push(`Price: $${t.price.toLocaleString()}`),t?.year&&a.push(`Year: ${t.year}`),t?.make&&a.push(`Make: ${t.make}`),t?.model&&a.push(`Model: ${t.model}`),t?.mileage&&a.push(`Mileage: ${t.mileage.toLocaleString()} miles`),t?.location&&a.push(`Location: ${t.location}`),t?.state&&a.push(`State: ${t.state}`);let r=a.length>0?`
EXTRACTED LISTING DATA (from URL parsing):
${a.map(e=>`- ${e}`).join("\n")}

USE THIS DATA: The information above was extracted from the URL structure. You MUST use these values when available:
- If price is provided, use it as the askingPrice
- If year/make/model are provided, use them for market analysis and fair price estimation
- If mileage is provided, adjust fair price accordingly (higher mileage = lower price)
- Tax rate will be provided by the backend based on buyer registration location - do not estimate tax rates
`:`
NOTE: No vehicle data could be automatically extracted from the URL. You must analyze the URL structure yourself to extract:
- Year, make, model from URL path patterns (e.g., /2020-honda-civic)
- Price from URL path or query parameters
- Mileage if mentioned
- Location/state if present
`,n="";return i?(i.combinedRate?n=`
TAX RATE ASSUMPTIONS (provided by backend):
- State Base Rate: ${i.stateBaseRate}%
- Estimated Local Add-on: ${i.estimatedLocalAddOn?.toFixed(2)||0}%
- Combined Rate: ${i.combinedRate.toFixed(2)}%
- Confidence: ${i.confidence}
- Source: ${i.source}
- Use this exact rate (${i.combinedRate.toFixed(2)}%) in OTD calculations
`:i.combinedRateRange&&(n=`
TAX RATE ASSUMPTIONS (provided by backend):
- State Base Rate: ${i.stateBaseRate}%
- Estimated Local Add-on: ${i.estimatedLocalAddOn?.toFixed(2)||0}%
- Combined Rate Range: ${i.combinedRateRange.low.toFixed(2)}% - ${i.combinedRateRange.high.toFixed(2)}%
- Confidence: ${i.confidence}
- Source: ${i.source}
- Use this range (${i.combinedRateRange.low.toFixed(2)}% - ${i.combinedRateRange.high.toFixed(2)}%) in OTD calculations
`),i.disclaimer&&(n+=`- Note: ${i.disclaimer}
`)):n=`
TAX RATE ASSUMPTIONS:
- No registration location provided
- Use default range: 6-7% (low confidence)
- User should provide registration state and ZIP for accurate rates
`,`Analyze this vehicle listing and create a comprehensive Deal Plan with SPECIFIC DOLLAR AMOUNTS.

LISTING URL: ${e}
${r}
${n}

IMPORTANT: The URL structure itself may contain valuable information:
- URL paths often include: year, make, model (e.g., /2020-honda-civic, /used/2020/honda/civic)
- Price may be in the URL path or query parameters (price=, listPrice=, etc.)
- Mileage may be mentioned in the URL
- Location/state may be in the URL path
- Dealer name may be in the URL structure

TASK:
1. FIRST: Use the extracted data provided above if available. This data was parsed from the URL structure.
2. SECOND: If data is missing, carefully analyze the URL structure yourself to extract any additional vehicle information (year, make, model, price, mileage, location, state)
3. Extract or estimate the asking price - PRIORITIZE the extracted price if provided, otherwise analyze the URL
3. Compute exact targets:
   - Estimated Fair Price (midpoint if comps exist, or asking - 3% if not)
   - Strong Opening Offer (fair - 2-4% if comps exist, or asking - 6% if not)
   - Acceptable Deal Price (fair - 0-2% if comps exist, or asking - 4% if not)
   - Walk-Away OTD Ceiling (expected OTD + 5-10%)
4. Assess leverage (4-8 factors with 0-100 scores):
   - Position in comp range
   - Mileage vs comps (use extracted mileage if available)
   - Trim rarity (if available from URL/model info)
   - Dealer type (if known from URL)
   - Price volatility (if price drops visible)
   - Missing info (CARFAX, accident history)
5. Calculate OTD estimates using the tax rate assumptions provided by the backend (doc fee $299-$699, registration $200-$600, add-ons $0-$1,500 risk)
   - Tax rate will be provided in the assumptions - do not estimate or guess tax rates
6. Predict 4-6 likely dealer tactics with counter-scripts
7. Generate 3 ready-to-send scripts with actual dollar amounts:
   - Initial email/text requesting itemized OTD
   - First counter offer (includes Opening Offer and OTD ceiling)
   - Walk-away/follow-up message
8. Set up next move links (Copilot, OTD Builder, Comparison)
   - Include extracted make/model/year in carContext if available

If you cannot extract specific numbers from the URL, use reasonable estimates based on:
- Typical pricing for the vehicle type (if make/model known)
- Market conditions
- Standard negotiation ranges

Return ONLY valid JSON matching the DealPlan structure.`}(d,m,w);Object.keys(m).length>0&&console.log("Extracted listing data:",m),w&&console.log("Tax rate resolved:",w);try{let e=await v.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:k},{role:"user",content:C}],response_format:{type:"json_object"},temperature:.7}),i=e.choices[0]?.message?.content;if(!i)throw Error("No response from AI");(t=JSON.parse(i)).otdEstimate||(t.otdEstimate={assumptions:{taxRate:{range:{low:0,high:0}},docFee:{range:{low:0,high:0}},registrationTitle:{range:{low:0,high:0}},dealerAddOns:{value:0,riskBand:{low:0,high:0}}},expectedOTD:{low:0,expected:0,high:0},warningThreshold:0,checklist:[]}),t.otdEstimate.assumptions||(t.otdEstimate.assumptions={taxRate:{range:{low:0,high:0}},docFee:{range:{low:0,high:0}},registrationTitle:{range:{low:0,high:0}},dealerAddOns:{value:0,riskBand:{low:0,high:0}}}),w&&(t.otdEstimate.assumptions.registrationState=g,t.otdEstimate.assumptions.registrationZip=f,t.otdEstimate.assumptions.taxRate={...t.otdEstimate.assumptions.taxRate,stateBaseRate:w.stateBaseRate,estimatedLocalAddOn:w.estimatedLocalAddOn,combinedRate:w.combinedRate,confidence:w.confidence,source:w.source,disclaimer:w.disclaimer,value:w.combinedRate,range:w.combinedRateRange||{low:w.stateBaseRate,high:w.stateBaseRate+2*(w.estimatedLocalAddOn||0)}}),t.nextMoves?.otdBuilderLink&&(m.state&&(t.nextMoves.otdBuilderLink.state=m.state),!t.nextMoves.otdBuilderLink.price&&t.targets?.askingPrice&&(t.nextMoves.otdBuilderLink.price=t.targets.askingPrice.toString()))}catch(y){let{parseMoney:e,parsePercentToDecimal:a,calculateOTDRange:r}=i(13730),n=e(m.price||25e3),o=Math.round(.97*n),s=Math.round(.94*n),l=Math.round(.96*n),c=a(6.5),u=r({vehiclePrice:o,taxRateDecimal:c,docFee:{low:299,high:699},registrationFee:{low:200,high:600},otherFees:0,addOns:0}),p=u.expected,h=Math.round(1.08*p);t={targets:{askingPrice:n,estimatedFairPrice:o,strongOpeningOffer:s,acceptableDealPrice:l,walkAwayOTDCeiling:h,percentRange:"3-7% below asking",estimationMethod:"Conservative estimate based on asking price"},leverage:{points:[{factor:"Position in comp range",score:50,strength:"medium",explanation:"Listing appears to be in the middle of comparable range"},{factor:"Mileage vs comps",score:40,strength:"medium",explanation:"Mileage appears average for vehicle age"}],bestAngles:["Request OTD breakdown","Compare with similar listings"]},otdEstimate:{assumptions:{registrationState:g,registrationZip:f,taxRate:w?{stateBaseRate:w.stateBaseRate,estimatedLocalAddOn:w.estimatedLocalAddOn,combinedRate:w.combinedRate,confidence:w.confidence,source:w.source,disclaimer:w.disclaimer,value:w.combinedRate,range:w.combinedRateRange||{low:w.stateBaseRate,high:w.stateBaseRate+2*(w.estimatedLocalAddOn||0)}}:{range:{low:6,high:7}},docFee:{range:{low:299,high:699}},registrationTitle:{range:{low:200,high:600}},dealerAddOns:{value:0,riskBand:{low:0,high:1500}}},expectedOTD:{low:Math.round(u.low),expected:Math.round(u.expected),high:Math.round(u.high)},warningThreshold:h>=.7*p&&h<=1.3*p?h:Math.round(1.1*p),checklist:["Request itemized OTD in writing","Verify all fees are legitimate"]},tactics:[{tactic:"May push for add-ons or extended warranty",likelihood:"high",counter:'Decline all add-ons and focus on base price. Say: "I\'m only interested in the base vehicle price."'},{tactic:'May ask you to "come in to discuss"',likelihood:"high",counter:'Request written OTD breakdown first. Say: "I\'d like to see the full breakdown in writing before I come in."'}],scripts:[{title:"Initial Email/Text - Request Itemized OTD",text:`Hi, I'm interested in the vehicle listed at ${d}. Can you provide the out-the-door price including all fees and taxes? I'd like a written breakdown showing: vehicle price, tax, doc fee, title, registration, and any other fees.`},{title:"First Counter Offer",text:`I've found similar vehicles in the area for $${s.toLocaleString()}. Can you match or beat that price? My maximum out-the-door budget is $${h.toLocaleString()}, so I need to see a complete breakdown to make sure we're in that range.`},{title:"Walk-Away / Follow-Up",text:`Thank you for your time. If you can get closer to $${l.toLocaleString()} out-the-door, I'm ready to move forward. Otherwise, I'll continue looking. Please let me know if anything changes.`}],nextMoves:{copilotLink:{vehiclePrice:n.toString(),desiredOTD:Math.round(.98*p).toString(),stage:"initial_outreach",goal:"get_otd",carContext:`Vehicle from ${d}`},otdBuilderLink:{price:n.toString(),state:m.state||void 0},comparisonLink:{dealer:d.match(/https?:\/\/(?:www\.)?([^/]+)/)?.[1]?.replace(/\.(com|net|org)/,"")||"Dealer",price:n,otdLow:Math.round(.98*p),otdHigh:Math.round(1.05*p),notes:`Target: $${l.toLocaleString()}`}}}}let x=p?{...p,sourceUrl:p.sourceUrl||d}:{sourceUrl:d,sourceSite:"other",confidence:0,issues:["No extraction performed"]},A=p?.diagnostics;if(A)a=A;else if(p){let e=p.fetchInfo;a={sourceUrl:d,finalUrl:e?.finalUrl||d,pageTitle:e?.pageTitle||null,fetchStatus:e?.fetchStatus??e?.status??-1,blocked:p.blocked||!1,errorType:e?.errorType||void 0,errorMessage:e?.errorMessage||e?.error||void 0,blockReason:e?.blockReason,contentType:e?.contentType,contentLength:e?.contentLength,fetchDebug:{contentType:e?.contentType,contentLength:e?.contentLength,attemptedHeaders:e?.attemptedHeaders||["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"],timeoutMs:12e3},platformDetected:p.raw?.platform||"unknown",extractionStrategyUsed:p.raw?.strategies?.[0]||"unknown",confidence:p.confidence||0,issues:p.issues||[],priceCandidates:(p.raw?.priceCandidates||[]).slice(0,5).map(e=>({value:e.value||e.price,label:e.label||"Unknown",source:e.source||"unknown",context:e.context||"",score:e.score||0,flags:{isMsrp:e.isLikelyMsrp||!1,isMonthlyPayment:e.isLikelyMonthlyPayment||!1,isConditional:e.isLikelyConditional||!1}})),mileageCandidates:(p.raw?.mileageCandidates||[]).slice(0,5).map(e=>({value:e.value,source:"dom",context:e.context||"",score:e.score||0}))}}else a={sourceUrl:d,finalUrl:d,pageTitle:null,fetchStatus:-1,blocked:!0,errorType:void 0,errorMessage:void 0,platformDetected:"unknown",extractionStrategyUsed:"none",confidence:0,issues:["No extraction performed"],fetchDebug:{attemptedHeaders:["User-Agent","Accept","Accept-Language","Referer","Cache-Control","Pragma"],timeoutMs:12e3},priceCandidates:[],mileageCandidates:[]};c.confirmedData&&(a.confirmedOverrides=Object.keys(c.confirmedData),Object.assign(x,c.confirmedData),x.confidence=1);let T={success:!0,requiresUserInput:!1,data:t,extractionResult:x,diagnostics:a,dealPlan:t,extractedListing:x};return s.NextResponse.json(T)}catch(e){return console.error("Listing analyzer error:",e),console.error("Error stack:",e?.stack),s.NextResponse.json({success:!1,error:e?.message||String(e)||"Failed to analyze listing"},{status:500})}}let C=new r.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/analyze-listing/route",pathname:"/api/analyze-listing",filename:"route",bundlePath:"app/api/analyze-listing/route"},resolvedPagePath:"C:\\dev\\Dealership Copilot\\app\\api\\analyze-listing\\route.ts",nextConfigOutput:"",userland:a}),{requestAsyncStorage:x,staticGenerationAsyncStorage:A,serverHooks:T}=C,S="/api/analyze-listing/route";function R(){return(0,o.patchFetch)({serverHooks:T,staticGenerationAsyncStorage:A})}},19692:(e,t,i)=>{i.d(t,{$:()=>s,f:()=>l});var a=i(67721),r=i(71615);let n="https://vabikejehdmpfcyqrgrs.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q";if(!n||!o){let e=[];throw n||e.push("NEXT_PUBLIC_SUPABASE_URL"),o||e.push("NEXT_PUBLIC_SUPABASE_ANON_KEY"),Error(`[CRITICAL] Missing required Supabase environment variables: ${e.join(", ")}. These must be set in Vercel environment variables.`)}if(n.includes("placeholder")||o.includes("placeholder"))throw Error("[CRITICAL] Supabase environment variables contain placeholder values. Please set real values in Vercel environment variables.");if(n.length<10||o.length<10)throw Error("[CRITICAL] Supabase environment variables appear to be invalid (too short). Please verify they are set correctly in Vercel.");function s(){let e=(0,r.cookies)();return(0,a.createServerClient)("https://vabikejehdmpfcyqrgrs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:i,options:a})=>{e.set(t,i,a)})}catch(e){}}}})}let l=s},13730:(e,t,i)=>{function a(e){if("number"==typeof e)return isNaN(e)||!isFinite(e)?0:Math.abs(e);if("string"==typeof e){let t=parseFloat(e.replace(/[$,\s]/g,""));return isNaN(t)||!isFinite(t)?0:Math.abs(t)}return 0}function r(e,t){let i=t?.maxPercent??15,a=t?.minPercent??0;if("number"==typeof e)return isNaN(e)||!isFinite(e)?0:e>1?Math.max(a/100,Math.min(i/100,e/100)):Math.max(a/100,Math.min(i/100,Math.abs(e)));if("string"==typeof e){let t=parseFloat(e.trim().replace(/%/g,""));return isNaN(t)||!isFinite(t)?0:e.includes("%")||t>1?Math.max(a/100,Math.min(i/100,t/100)):Math.max(a/100,Math.min(i/100,Math.abs(t)))}return 0}function n(e){let t=[],i=a(e.vehiclePrice),n=r(e.taxRateDecimal),o=a(e.docFee??0),s=a(e.registrationFee??0),l=a(e.titleFee??0),c=a(e.otherFees??0),d=a(e.addOns??0);i<=0&&t.push("Vehicle price must be greater than 0"),i>1e6&&t.push("Vehicle price seems unusually high (>$1M). Please verify."),(n<0||n>.15)&&t.push(`Tax rate ${(100*n).toFixed(2)}% is outside normal range (0-15%). Please verify.`);let u=i*n,m=o+s+l+c,p=i+u+m+d;return p>1.5*i&&t.push(`OTD ($${p.toLocaleString()}) is more than 50% above vehicle price ($${i.toLocaleString()}). Please check fees and tax rate.`),p<i&&t.push(`OTD ($${p.toLocaleString()}) is less than vehicle price ($${i.toLocaleString()}). This is unusual.`),(isNaN(p)||!isFinite(p))&&t.push("OTD calculation resulted in invalid number. Please check all inputs."),{vehiclePrice:i,taxRateDecimal:n,taxAmount:u,fees:m,addOns:d,otd:Math.round(100*p)/100,issues:t}}function o(e){let t=[],i=n({vehiclePrice:e.vehiclePrice,taxRateDecimal:e.taxRateDecimal,docFee:e.docFee?.low??0,registrationFee:e.registrationFee?.low??0,titleFee:e.titleFee?.low??0,otherFees:e.otherFees??0,addOns:e.addOns??0}),a=e.docFee?(e.docFee.low+e.docFee.high)/2:0,r=e.registrationFee?(e.registrationFee.low+e.registrationFee.high)/2:0,o=e.titleFee?(e.titleFee.low+e.titleFee.high)/2:0,s=n({vehiclePrice:e.vehiclePrice,taxRateDecimal:e.taxRateDecimal,docFee:a,registrationFee:r,titleFee:o,otherFees:e.otherFees??0,addOns:e.addOns??0}),l=n({vehiclePrice:e.vehiclePrice,taxRateDecimal:e.taxRateDecimal,docFee:e.docFee?.high??0,registrationFee:e.registrationFee?.high??0,titleFee:e.titleFee?.high??0,otherFees:e.otherFees??0,addOns:e.addOns??0});return t.push(...i.issues,...s.issues,...l.issues),l.otd<i.otd&&t.push("High OTD estimate is less than low estimate. Please check fee ranges."),(s.otd<i.otd||s.otd>l.otd)&&t.push("Expected OTD is outside the low-high range. Please check calculations."),s.otd,s.otd,{low:i.otd,expected:s.otd,high:l.otd,issues:[...new Set(t)]}}i.r(t),i.d(t,{calculateOTD:()=>n,calculateOTDRange:()=>o,parseMoney:()=>a,parsePercentToDecimal:()=>r})},74918:(e,t,i)=>{i.d(t,{A:()=>s});var a=i(93950);async function r(e){let t=process.env.TAXJAR_API_KEY;if(!t)return null;try{let i=await fetch(`https://api.taxjar.com/v2/rates/${e}`,{headers:{Authorization:`Bearer ${t}`,"Content-Type":"application/json"}});if(!i.ok)return null;let a=await i.json();return a.rate?.combined_rate?100*parseFloat(a.rate.combined_rate):null}catch(e){return console.warn("TaxJar lookup failed:",e),null}}async function n(e,t){let i=process.env.AVALARA_ACCOUNT_ID,a=process.env.AVALARA_LICENSE_KEY;if(!i||!a)return null;try{let t=`${i}:${a}`,r="undefined"!=typeof Buffer?Buffer.from(t).toString("base64"):btoa(t),n=await fetch(`https://rest.avatax.com/api/v2/taxrates/bypostalcode?country=US&postalCode=${e}`,{headers:{Authorization:`Basic ${r}`,"Content-Type":"application/json"}});if(!n.ok)return null;let o=await n.json();return o.totalRate?100*parseFloat(o.totalRate):null}catch(e){return console.warn("Avalara lookup failed:",e),null}}function o(e){let t=e.toUpperCase().trim();return["CA","NY","IL","TX","FL","PA"].includes(t)?{low:.5,high:2.5}:["CO","MO","OH","MI","NC","GA"].includes(t)?{low:.25,high:1.5}:{low:0,high:1}}async function s(e,t){let i=e.toUpperCase().trim(),s=(0,a.getTaxRateForState)(i);if(!s&&0!==s)return{stateBaseRate:0,combinedRateRange:{low:0,high:0},confidence:"low",source:"state_estimate",provider:"fallback",disclaimer:"State not found in tax rate table. Please verify tax rate manually."};if(t){let e=t.replace(/[^0-9]/g,"").slice(0,5),a=await r(e);if(null!==a){let e=a-s;return{stateBaseRate:s,estimatedLocalAddOn:e>0?e:0,combinedRate:a,confidence:"high",source:"zip_lookup",provider:"taxjar",disclaimer:"Rate based on ZIP code lookup. Vehicle tax rules vary by state and may differ from general sales tax. Verify with dealer itemization."}}let l=await n(e,i);if(null!==l){let e=l-s;return{stateBaseRate:s,estimatedLocalAddOn:e>0?e:0,combinedRate:l,confidence:"high",source:"zip_lookup",provider:"avalara",disclaimer:"Rate based on ZIP code lookup. Vehicle tax rules vary by state and may differ from general sales tax. Verify with dealer itemization."}}let c=o(i),d=s+c.low,u=s+c.high;return{stateBaseRate:s,estimatedLocalAddOn:(c.low+c.high)/2,combinedRateRange:{low:d,high:u},confidence:"medium",source:"state_table",provider:"fallback",disclaimer:"ZIP lookup unavailable. Using state base rate + estimated local range. Vehicle tax rules vary by state and may differ from general sales tax. Verify with dealer itemization."}}let l=o(i),c=s+l.low,d=s+l.high;return{stateBaseRate:s,estimatedLocalAddOn:(l.low+l.high)/2,combinedRateRange:{low:c,high:d},confidence:"low",source:"state_estimate",provider:"fallback",disclaimer:"ZIP code not provided. Using state base rate + estimated local range. For accurate rates, provide ZIP code. Vehicle tax rules vary by state and may differ from general sales tax. Verify with dealer itemization."}}},93950:(e,t,i)=>{i.r(t),i.d(t,{formatStateName:()=>n,getTaxRateForState:()=>r,stateTaxRates:()=>a});let a={AL:2,AK:0,AZ:5.6,AR:6.5,CA:7.25,CO:2.9,CT:6.35,DE:0,FL:6,GA:4,HI:4.17,ID:6,IL:6.25,IN:7,IA:6,KS:6.5,KY:6,LA:4.45,ME:5.5,MD:6,MA:6.25,MI:6,MN:6.875,MS:5,MO:4.225,MT:0,NE:5.5,NV:6.85,NH:0,NJ:6.625,NM:5.125,NY:4,NC:4.75,ND:5,OH:5.75,OK:4.5,OR:0,PA:6,RI:7,SC:6,SD:4.5,TN:7,TX:6.25,UT:4.85,VT:6,VA:4.3,WA:6.5,WV:6,WI:5,WY:4,DC:6};function r(e){return a[e.toUpperCase().trim()]??null}function n(e){return({AL:"Alabama",AK:"Alaska",AZ:"Arizona",AR:"Arkansas",CA:"California",CO:"Colorado",CT:"Connecticut",DE:"Delaware",FL:"Florida",GA:"Georgia",HI:"Hawaii",ID:"Idaho",IL:"Illinois",IN:"Indiana",IA:"Iowa",KS:"Kansas",KY:"Kentucky",LA:"Louisiana",ME:"Maine",MD:"Maryland",MA:"Massachusetts",MI:"Michigan",MN:"Minnesota",MS:"Mississippi",MO:"Missouri",MT:"Montana",NE:"Nebraska",NV:"Nevada",NH:"New Hampshire",NJ:"New Jersey",NM:"New Mexico",NY:"New York",NC:"North Carolina",ND:"North Dakota",OH:"Ohio",OK:"Oklahoma",OR:"Oregon",PA:"Pennsylvania",RI:"Rhode Island",SC:"South Carolina",SD:"South Dakota",TN:"Tennessee",TX:"Texas",UT:"Utah",VT:"Vermont",VA:"Virginia",WA:"Washington",WV:"West Virginia",WI:"Wisconsin",WY:"Wyoming",DC:"District of Columbia"})[e.toUpperCase()]||e}}};var t=require("../../../webpack-runtime.js");t.C(e);var i=e=>t(t.s=e),a=t.X(0,[8948,5972,7857,9702,4214,917],()=>i(98986));module.exports=a})();