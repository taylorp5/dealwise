"use strict";(()=>{var e={};e.id=2757,e.ids=[2757],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},61282:e=>{e.exports=require("child_process")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},21764:e=>{e.exports=require("util")},37548:(e,r,t)=>{t.r(r),t.d(r,{originalPathname:()=>g,patchFetch:()=>E,requestAsyncStorage:()=>_,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>m});var s={};t.r(s),t.d(s,{POST:()=>d,dynamic:()=>l,runtime:()=>p});var o=t(49303),n=t(88716),i=t(60670),a=t(87070),u=t(44273),c=t(37857);let p="nodejs",l="force-dynamic";async function d(e){let r;let t=process.env.STRIPE_WEBHOOK_SECRET,s=process.env.STRIPE_SECRET_KEY;if(!t)return console.error("[Webhook] STRIPE_WEBHOOK_SECRET not configured"),a.NextResponse.json({error:"Webhook secret not configured"},{status:500});if(!s)return console.error("[Webhook] STRIPE_SECRET_KEY not configured"),a.NextResponse.json({error:"Stripe secret key not configured"},{status:500});let o=new u.Z(s,{apiVersion:"2025-12-15.clover"}),n=await e.text(),i=e.headers.get("stripe-signature");if(!i)return console.error("[Webhook] Missing stripe-signature header"),a.NextResponse.json({error:"Missing signature"},{status:400});try{r=o.webhooks.constructEvent(n,i,t)}catch(e){return console.error("[Webhook] Signature verification failed:",e.message),a.NextResponse.json({error:`Webhook signature verification failed: ${e.message}`},{status:400})}if("checkout.session.completed"===r.type){let e=r.data.object;try{let r=e.client_reference_id||e.metadata?.user_id,t=e.metadata?.pack_key,s=e.id;if(!r)return console.error("[Webhook] Missing user_id in client_reference_id and metadata:",{sessionId:s}),a.NextResponse.json({error:"Missing user_id"},{status:400});let n=t||null;if(!n&&e.line_items){let e=await o.checkout.sessions.listLineItems(s,{limit:1});if(e.data.length>0){let r=e.data[0].price?.id,t={[process.env.STRIPE_PRICE_FIRST_TIME||""]:"first_time",[process.env.STRIPE_PRICE_IN_PERSON||""]:"in_person",[process.env.STRIPE_PRICE_BUNDLE||""]:"bundle"};n=r&&t[r]||null}}if(!n)return console.error("[Webhook] Could not determine purchased pack:",{sessionId:s,userId:r}),a.NextResponse.json({error:"Could not determine purchased pack"},{status:400});console.log(`[Webhook] Processing checkout.session.completed for user ${r}, pack ${n}, session ${s}`);let i=function(){let e="https://vabikejehdmpfcyqrgrs.supabase.co",r=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!r)throw Error("Missing Supabase configuration for webhook");return(0,c.createClient)(e,r,{auth:{persistSession:!1,autoRefreshToken:!1}})}(),u=!1,p=!1,l=!1;"first_time"===n?u=!0:"in_person"===n?p=!0:("bundle"===n||"bundle_both"===n)&&(l=!0,u=!0,p=!0);let{error:d}=await i.from("user_entitlements").upsert({user_id:r,first_time:u,in_person:p,bundle:l,updated_at:new Date().toISOString()},{onConflict:"user_id"});if(d){if(console.error("[Webhook] Error upserting entitlements:",d),d.message?.includes("does not exist")||d.message?.includes("schema cache"))return console.error("[Webhook] Table user_entitlements does not exist. Please run the migration: supabase/migrations/001_user_entitlements.sql"),a.NextResponse.json({error:"Database table not found. Please create user_entitlements table. See docs/QUICK_SETUP_USER_ENTITLEMENTS.md",details:d.message},{status:500});throw d}return console.log(`[Webhook] Successfully updated entitlements for user ${r}: first_time=${u}, in_person=${p}, bundle=${l}`),a.NextResponse.json({received:!0})}catch(e){return console.error("[Webhook] Error processing checkout.session.completed:",e),a.NextResponse.json({error:"Error processing webhook",message:e.message},{status:500})}}return console.log(`[Webhook] Received unhandled event type: ${r.type}`),a.NextResponse.json({received:!0})}let h=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/stripe/webhook/route",pathname:"/api/stripe/webhook",filename:"route",bundlePath:"app/api/stripe/webhook/route"},resolvedPagePath:"C:\\dev\\Dealership Copilot\\app\\api\\stripe\\webhook\\route.ts",nextConfigOutput:"",userland:s}),{requestAsyncStorage:_,staticGenerationAsyncStorage:m,serverHooks:f}=h,g="/api/stripe/webhook/route";function E(){return(0,i.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:m})}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),s=r.X(0,[8948,5972,7857,4273],()=>t(37548));module.exports=s})();