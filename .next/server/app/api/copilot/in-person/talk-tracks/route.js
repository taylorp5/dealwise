"use strict";(()=>{var e={};e.id=5300,e.ids=[5300],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},81066:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>S,patchFetch:()=>T,requestAsyncStorage:()=>m,routeModule:()=>h,serverHooks:()=>f,staticGenerationAsyncStorage:()=>y});var r={};a.r(r),a.d(r,{POST:()=>p});var n=a(49303),s=a(88716),o=a(60670),i=a(87070),l=a(19692),c=a(37857),d=a(54214);let u=process.env.OPENAI_API_KEY?new d.ZP({apiKey:process.env.OPENAI_API_KEY}):null;function g(e){let{inPersonSituation:t,targetOTD:a,walkAwayOTD:r,currentDealerOTD:n,ladder:s,currentStepIndex:o}=e,i=`I need $${a.toLocaleString()} OTD. Can you show me the breakdown?`,l="I understand. I still need the full OTD breakdown to make a decision.",c=`I need $${a.toLocaleString()} OTD. Can you make that happen?`,d=`If you can do $${a.toLocaleString()} OTD, I'm ready to move forward.`,u="Request written itemized OTD breakdown",g=[],p=[];if(t.toLowerCase().includes("monthly payment")||t.toLowerCase().includes("monthly"))i="I'm focused on the total out-the-door price, not monthly payments. What's your OTD?",l="I need the OTD number, not monthly payment talk. Can you show me the breakdown?",u="Repeat OTD request and stay silent",g=["They keep pushing monthly payment talk","They stretch loan term to make payment seem lower"],p=["Mentioning a monthly payment range","Discussing financing terms before OTD is locked"];else if(t.toLowerCase().includes("add-on")||t.toLowerCase().includes("addon"))i=`Which add-ons are removable? If they're mandatory, let's adjust the sale price to hit my target OTD of $${a.toLocaleString()}.`,l="If add-ons are fixed, reduce the sale price to keep OTD at my target.",u="Get written breakdown showing which add-ons are removable",g=["They won't show which add-ons are removable","They add fees after you agree to a price"],p=['Accepting "mandatory" add-ons without questioning',"Agreeing to add-ons before seeing OTD"];else if(t.toLowerCase().includes("manager"))i=`If you can do $${a.toLocaleString()} OTD, I'm ready to move forward now.`,c=`I need $${a.toLocaleString()} OTD. Can you make that happen?`,d=`If you can do $${a.toLocaleString()} OTD, I'm ready to sign.`,u="Repeat target OTD and stay silent",g=["Manager creates fake urgency","Manager \"can't go lower\" but won't show why"],p=["Explaining or justifying your number","Filling the silence with talk"];else if(t.toLowerCase().includes("fees")||t.toLowerCase().includes("non-negotiable"))i=`I need to see which fees are negotiable. If they're fixed, let's adjust the sale price to hit my target OTD of $${a.toLocaleString()}.`,l="If fees are fixed, reduce the sale price to keep OTD at my target.",u="Get itemized fee breakdown in writing",g=['They say "everyone pays this" without explanation',"Fees increase unexpectedly"],p=["Accepting fees without seeing breakdown","Agreeing to fees before OTD is confirmed"];else if(t.toLowerCase().includes("counter")||t.toLowerCase().includes("counter offer")){if(n){let e=n-a;e>1e3?(i=`That's $${e.toLocaleString()} above my target. I need $${a.toLocaleString()} OTD.`,u="Push for target OTD or walk if they refuse",g=["Large gap suggests they won't negotiate","They won't show itemized breakdown"]):e<=0?(i="That works. Can you show me the itemized breakdown to confirm?",u="Review breakdown and confirm it matches, then close",g=[]):(i=`I need $${a.toLocaleString()} OTD. Can you get there?`,u="Push for target OTD using closing line",g=["They won't negotiate further","They add fees after counter"])}else i=`I need $${a.toLocaleString()} OTD. Can you show me the breakdown?`,u="Get written OTD breakdown before responding"}return s.locked&&n&&n>s.walk&&(i=`That's above my walk-away number. I need $${s.agree.toLocaleString()} OTD.`,d=`I can't go above $${s.walk.toLocaleString()}. My target is $${s.agree.toLocaleString()} OTD.`,u="Walk away if they won't negotiate to target",g=["Dealer is above walk-away ceiling","They won't negotiate to target"]),{sayThis:i,ifPushback:l,ifManager:c,stopSignal:`Repeat $${a.toLocaleString()} OTD and stay silent.`,closingLine:d,nextMove:u,ladderSummary:`ASK: $${s.ask.toLocaleString()}, AGREE: $${s.agree.toLocaleString()}, WALK: $${s.walk.toLocaleString()}`,redFlags:g.length>0?g:["They refuse to give written OTD","They push monthly payment talk before OTD"],doNotSay:p.length>0?p:["Discussing monthly payments before OTD","Accepting numbers without written breakdown"]}}async function p(e){try{let t;let a=await (0,l.f)(),r=e.headers.get("authorization"),n=null;if(r?.startsWith("Bearer ")){let e=r.substring(7),{data:{user:t},error:s}=await a.auth.getUser(e);t&&!s&&(n=t.id)}if(!n){let{data:{session:e}}=await a.auth.getSession();e?.user&&(n=e.user.id)}if(!n)return i.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let s=!1,o=!1;try{if(process.env.SUPABASE_SERVICE_ROLE_KEY){let e=(0,c.createClient)("https://vabikejehdmpfcyqrgrs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}}),{data:t}=await e.from("user_packs").select("pack_id").eq("user_id",n).eq("pack_id","in_person").single();s=!!t,o=!!u&&!!process.env.SUPABASE_SERVICE_ROLE_KEY}else s=!0,o=!!u}catch(e){console.error("Error checking pack entitlement:",e),process.env.SUPABASE_SERVICE_ROLE_KEY||(s=!0,o=!!u)}if(!s)return i.NextResponse.json({success:!1,error:"Pack required",code:"PACK_REQUIRED"},{status:403});let d=await e.json();if("in_person_live"!==d.mode||"number"!=typeof d.currentStepIndex||d.currentStepIndex<0||d.currentStepIndex>4||!d.inPersonSituation||"number"!=typeof d.targetOTD||"number"!=typeof d.walkAwayOTD||!d.state||!d.ladder||"number"!=typeof d.ladder.ask||"number"!=typeof d.ladder.agree||"number"!=typeof d.ladder.walk)return i.NextResponse.json({success:!1,error:"Invalid request schema",details:void 0},{status:400});if(!o||!u){let e=g(d);return i.NextResponse.json({success:!0,data:e,aiEnabled:!1,source:"canned_fallback",effectiveMode:"in_person_live"})}let p=`You are a real-time dealership negotiation coach providing tactical, spoken-language talk tracks during in-person negotiations. You are sitting next to the user during the negotiation.

CRITICAL RULES:
1. ALL talk tracks must be 1-2 sentences MAX - designed to be spoken out loud
2. Use spoken-language tone (natural, conversational, not email-style)
3. End with silence - let the dealer respond, don't over-explain
4. Always focus on OTD (Out-The-Door) price - NEVER discuss monthly payments
5. Be firm, calm, and OTD-focused - no hedging or soft language
6. Generate concise, repeatable phrases the user can say immediately
7. NO email framing, NO upsell copy, NO "Best Next Message" language
8. You MUST incorporate the user's specific numbers (targetOTD, walkAwayOTD) explicitly in your talk tracks
9. You MUST tailor responses to the selected situation
10. If the situation involves monthly payments, you MUST refuse payment discussion and redirect to OTD
11. If the situation involves add-ons, you MUST address add-ons specifically
12. If the situation involves manager, you MUST provide manager-specific response

Your response MUST be a JSON object with this EXACT structure. ALL fields are REQUIRED and MUST be non-empty strings (or arrays for redFlags/doNotSay):
{
  "sayThis": "<Primary talk track, 1-2 sentences, spoken language, MUST include targetOTD number explicitly, <= 150 chars>",
  "ifPushback": "<Response if dealer pushes back, 1-2 sentences, MUST address the specific situation, <= 150 chars>",
  "ifManager": "<Response if manager joins, 1-2 sentences, firm and closing-oriented, MUST include targetOTD, <= 150 chars>",
  "stopSignal": "<What to do next physically, e.g., 'Repeat $X OTD and stay silent', <= 100 chars>",
  "closingLine": "<Authoritative closing statement, MUST include targetOTD explicitly, no soft language, <= 150 chars>",
  "nextMove": "<ONE sentence instruction, what user should do next immediately, <= 120 chars>",
  "ladderSummary": "<Brief summary of ASK/AGREE/WALK numbers, <= 100 chars>",
  "redFlags": ["<Max 3 red flags, each <= 80 chars>"],
  "doNotSay": ["<Max 2 things to avoid saying, each <= 80 chars>"]
}

CRITICAL: You MUST return ALL required fields. Missing or empty fields will cause an error.`,h=function(e,t,a,r,n,s,o,i,l){let c=o&&r>0?o-r:null;return`SITUATION: ${e||"Standard negotiation"}

USER'S NUMBERS:
- Target OTD: $${r.toLocaleString()}
- Walk-Away Ceiling: $${n.toLocaleString()}
- Negotiation Ladder:
  * ASK: $${i.ask.toLocaleString()}
  * AGREE: $${i.agree.toLocaleString()}
  * WALK: $${i.walk.toLocaleString()}
  * LOCKED: ${i.locked?"YES":"NO"}

${a>0?`- Vehicle Price: $${a.toLocaleString()}`:""}
- State: ${s}

${o?`- Dealer Current OTD: $${o.toLocaleString()}`:"- Dealer Current OTD: Not provided yet"}
${null!==c?`- GAP: $${c>=0?"+":""}${c.toLocaleString()} ${c<=0?"(DEALER BELOW TARGET - GOOD)":c<=500?"(CLOSE - NEGOTIABLE)":"(LARGE GAP - NEEDS WORK)"}`:"- GAP: Unknown"}

${t?`DEALER SAID: "${t}"`:""}

${l&&l.length>0?`RECENT TIMELINE:
${l.map(e=>`- ${e.label}`).join("\n")}`:""}

INSTRUCTIONS:
1. Generate talk tracks that EXPLICITLY reference the target OTD ($${r.toLocaleString()}) in sayThis and closingLine
2. Tailor ALL responses to the selected situation: "${e}"
3. If situation is about monthly payments: sayThis MUST refuse payment discussion and redirect to OTD
4. If situation is about add-ons: sayThis MUST address add-ons specifically
5. If situation is about manager: ifManager MUST be firm and closing-oriented
6. ifPushback MUST address the likely dealer pushback for this specific situation
7. nextMove MUST tell user what to do immediately based on the situation
8. redFlags MUST be specific to this situation (max 3)
9. doNotSay MUST be specific to this situation (max 2)

Return ONLY valid JSON with ALL required fields.`}(d.inPersonSituation,d.dealerSaidText,d.vehiclePrice||0,d.targetOTD,d.walkAwayOTD,d.state,d.currentDealerOTD,d.ladder,d.timelineTail),m=await u.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:p},{role:"user",content:h}],response_format:{type:"json_object"},temperature:.7});try{t=JSON.parse(m.choices[0].message.content||"{}")}catch(a){let e=await u.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:p},{role:"user",content:h+"\n\nCRITICAL: Return ONLY valid JSON with ALL required fields: sayThis, ifPushback, ifManager, stopSignal, closingLine, nextMove, ladderSummary, redFlags (array), doNotSay (array)."}],response_format:{type:"json_object"},temperature:.7});try{t=JSON.parse(e.choices[0].message.content||"{}")}catch(e){t=g(d)}}let y=["sayThis","ifPushback","ifManager","stopSignal","closingLine","nextMove","ladderSummary","redFlags","doNotSay"].filter(e=>"redFlags"===e||"doNotSay"===e?!Array.isArray(t[e])||0===t[e].length:!t[e]||0===String(t[e]).trim().length);y.length>0&&(console.warn("AI response missing fields:",y),t=g(d));let f={sayThis:String(t.sayThis||"").substring(0,150),ifPushback:String(t.ifPushback||"").substring(0,150),ifManager:String(t.ifManager||"").substring(0,150),stopSignal:String(t.stopSignal||"").substring(0,100),closingLine:String(t.closingLine||"").substring(0,150),nextMove:String(t.nextMove||"").substring(0,120),ladderSummary:String(t.ladderSummary||"").substring(0,100),redFlags:Array.isArray(t.redFlags)?t.redFlags.slice(0,3).map(e=>String(e).substring(0,80)):[],doNotSay:Array.isArray(t.doNotSay)?t.doNotSay.slice(0,2).map(e=>String(e).substring(0,80)):[]};return i.NextResponse.json({success:!0,data:f,aiEnabled:!0,source:"ai",effectiveMode:"in_person_live",debug:void 0})}catch(e){return console.error("Error in talk tracks:",e),i.NextResponse.json({success:!1,error:e.message||"Failed to generate talk tracks"},{status:500})}}let h=new n.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/copilot/in-person/talk-tracks/route",pathname:"/api/copilot/in-person/talk-tracks",filename:"route",bundlePath:"app/api/copilot/in-person/talk-tracks/route"},resolvedPagePath:"C:\\dev\\Dealership Copilot\\app\\api\\copilot\\in-person\\talk-tracks\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:y,serverHooks:f}=h,S="/api/copilot/in-person/talk-tracks/route";function T(){return(0,o.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:y})}},19692:(e,t,a)=>{a.d(t,{$:()=>i,f:()=>l});var r=a(67721),n=a(71615);let s="https://vabikejehdmpfcyqrgrs.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q";if(!s||!o){let e=[];throw s||e.push("NEXT_PUBLIC_SUPABASE_URL"),o||e.push("NEXT_PUBLIC_SUPABASE_ANON_KEY"),Error(`[CRITICAL] Missing required Supabase environment variables: ${e.join(", ")}. These must be set in Vercel environment variables.`)}if(s.includes("placeholder")||o.includes("placeholder"))throw Error("[CRITICAL] Supabase environment variables contain placeholder values. Please set real values in Vercel environment variables.");if(s.length<10||o.length<10)throw Error("[CRITICAL] Supabase environment variables appear to be invalid (too short). Please verify they are set correctly in Vercel.");function i(){let e=(0,n.cookies)();return(0,r.createServerClient)("https://vabikejehdmpfcyqrgrs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:a,options:r})=>{e.set(t,a,r)})}catch(e){}}}})}let l=i}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,7857,9702,4214],()=>a(81066));module.exports=r})();