"use strict";(()=>{var e={};e.id=8591,e.ids=[8591],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},92048:e=>{e.exports=require("fs")},32615:e=>{e.exports=require("http")},35240:e=>{e.exports=require("https")},55315:e=>{e.exports=require("path")},68621:e=>{e.exports=require("punycode")},76162:e=>{e.exports=require("stream")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},71568:e=>{e.exports=require("zlib")},87561:e=>{e.exports=require("node:fs")},84492:e=>{e.exports=require("node:stream")},72477:e=>{e.exports=require("node:stream/web")},99830:(e,t,a)=>{a.r(t),a.d(t,{originalPathname:()=>I,patchFetch:()=>T,requestAsyncStorage:()=>m,routeModule:()=>g,serverHooks:()=>y,staticGenerationAsyncStorage:()=>S});var r={};a.r(r),a.d(r,{POST:()=>h});var s=a(49303),n=a(88716),o=a(60670),i=a(87070),l=a(19692),u=a(37857),c=a(54214);let d=process.env.OPENAI_API_KEY?new c.ZP({apiKey:process.env.OPENAI_API_KEY}):null;function p(e){let{message:t,dealState:a}=e,r=t.match(/\$?([\d,]+)/g),s=null;if(r){let e=r.map(e=>parseFloat(e.replace(/[$,]/g,""))).filter(e=>e>1e3&&e<2e5);e.length>0&&(s=e[0])}let n=t.toLowerCase(),o="",i=null;return n.includes("monthly")||n.includes("payment")?(o="Stay focused on OTD. Say: 'I'm not discussing monthly payments yet. What's the out-the-door price?'",i="I'm not discussing monthly payments yet. What's the out-the-door price?"):n.includes("add-on")||n.includes("fee")?(o="Ask which are removable. Say: 'Which add-ons are removable? If they're mandatory, let's adjust the sale price to hit my target OTD.'",i="Which add-ons are removable? If they're mandatory, let's adjust the sale price to hit my target OTD."):n.includes("manager")?(o="Stay firm. Repeat your target OTD and wait. Say: 'If you can do $X OTD, I'm ready to move forward now.'",a.targetOTD&&(i=`If you can do $${a.targetOTD.toLocaleString()} OTD, I'm ready to move forward now.`)):n.includes("walk")||n.includes("leave")?(o="If dealer is above your walk-away, walk. Otherwise, repeat your target OTD one more time and wait.",a.targetOTD&&(i=`I need $${a.targetOTD.toLocaleString()} OTD. Can you make that happen?`)):(o="Stay focused on your target OTD. Get everything in writing before agreeing to anything.",a.targetOTD&&(i=`I need $${a.targetOTD.toLocaleString()} OTD. Can you show me the breakdown?`)),{reply:o,nextQuestion:null,suggestedTalkTrack:i,updateDealState:s?{dealerOTD:s}:null}}async function h(e){try{let t;let a=await (0,l.f)(),r=e.headers.get("authorization"),s=null;if(r?.startsWith("Bearer ")){let e=r.substring(7),{data:{user:t},error:n}=await a.auth.getUser(e);t&&!n&&(s=t.id)}if(!s){let{data:{session:e}}=await a.auth.getSession();e?.user&&(s=e.user.id)}if(!s)return i.NextResponse.json({success:!1,error:"Unauthorized"},{status:401});let n=!1,o=!1;try{if(process.env.SUPABASE_SERVICE_ROLE_KEY){let e=(0,u.createClient)("https://vabikejehdmpfcyqrgrs.supabase.co",process.env.SUPABASE_SERVICE_ROLE_KEY,{auth:{persistSession:!1}}),{data:t}=await e.from("user_packs").select("pack_id").eq("user_id",s).eq("pack_id","in_person").single();n=!!t,o=!!d&&!!process.env.SUPABASE_SERVICE_ROLE_KEY}else n=!0,o=!!d}catch(e){console.error("Error checking pack entitlement:",e),process.env.SUPABASE_SERVICE_ROLE_KEY||(n=!0,o=!!d)}if(!n)return i.NextResponse.json({success:!1,error:"Pack required",code:"PACK_REQUIRED"},{status:403});let c=await e.json();if(!c.message||!c.dealState)return i.NextResponse.json({success:!1,error:"Invalid request schema"},{status:400});if(!o||!d){let e=p(c);return i.NextResponse.json({success:!0,data:e,aiEnabled:!1,source:"deterministic_fallback"})}let h=c.dealState.dealerCurrentOTD&&c.dealState.targetOTD?c.dealState.dealerCurrentOTD-c.dealState.targetOTD:null,g=`You are a real-time dealership negotiation coach providing short, tactical, spoken-language guidance during in-person negotiations. You are sitting next to the user during the negotiation.

CRITICAL RULES:
1. ALL responses must be 1-2 sentences MAX - designed to be spoken out loud
2. Use spoken-language tone (natural, conversational, not email-style)
3. End with silence - let the dealer respond, don't over-explain
4. Always focus on OTD (Out-The-Door) price - NEVER discuss monthly payments
5. Be firm, calm, and OTD-focused - no hedging or soft language
6. Ask clarifying questions when info is missing (OTD, add-ons, fees, trade-in, financing pressure)
7. Never produce long educational essays
8. Always end with either: (a) a talk track, or (b) a question needed to proceed
9. Always respect the ladder (ASK/AGREE/WALK) if provided
10. Do NOT mention "ChatGPT" or "AI model" - you are a coach, not an AI

CURRENT DEAL STATE:
${c.dealState.targetOTD?`- Target OTD: $${c.dealState.targetOTD.toLocaleString()}`:"Target OTD: Not set"}
${c.dealState.walkAwayOTD?`- Walk-away: $${c.dealState.walkAwayOTD.toLocaleString()}`:"Walk-away: Not set"}
${c.dealState.dealerCurrentOTD?`- Dealer OTD: $${c.dealState.dealerCurrentOTD.toLocaleString()}`:"Dealer OTD: Not provided"}
${null!==h?`- Gap: $${h>=0?"+":""}${h.toLocaleString()}`:"- Gap: Unknown"}
${c.dealState.currentSituation?`- Situation: ${c.dealState.currentSituation}`:""}
${c.dealState.ladder?`- Ladder: ASK $${c.dealState.ladder.ask.toLocaleString()}, AGREE $${c.dealState.ladder.agree.toLocaleString()}, WALK $${c.dealState.ladder.walk.toLocaleString()}`:""}

${c.dealState.timelineEvents&&c.dealState.timelineEvents.length>0?`RECENT TIMELINE:
${c.dealState.timelineEvents.slice(-3).map(e=>`- ${e.label}`).join("\n")}`:""}

Your response MUST be a JSON object with this EXACT structure:
{
  "reply": "<Your response to the user's question, 1-2 sentences, spoken language, <= 150 chars>",
  "nextQuestion": "<If you need more info, ask ONE clarifying question, <= 100 chars. Otherwise null>",
  "suggestedTalkTrack": "<If you can provide a talk track, give ONE sentence they can say, <= 100 chars. Otherwise null>",
  "updateDealState": "<If message contains a dollar amount that looks like dealer OTD, include { "dealerOTD": number }. Otherwise null>"
}

CRITICAL: You MUST return ALL required fields. Missing fields will cause an error.`,m=`USER ASKED: "${c.message}"

Provide short, tactical guidance. If the message contains a dollar amount, it might be a dealer OTD offer - extract it if it's in the 1000-200000 range.

Return ONLY valid JSON with ALL required fields.`,S=await d.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:g},{role:"user",content:m}],response_format:{type:"json_object"},temperature:.7});try{t=JSON.parse(S.choices[0].message.content||"{}")}catch(a){let e=await d.chat.completions.create({model:"gpt-4o-mini",messages:[{role:"system",content:g},{role:"user",content:m+"\n\nCRITICAL: Return ONLY valid JSON with ALL required fields: reply, nextQuestion, suggestedTalkTrack, updateDealState."}],response_format:{type:"json_object"},temperature:.7});try{t=JSON.parse(e.choices[0].message.content||"{}")}catch(e){t=p(c)}}t.reply||(t=p(c));let y={reply:String(t.reply||"").substring(0,150),nextQuestion:t.nextQuestion?String(t.nextQuestion).substring(0,100):null,suggestedTalkTrack:t.suggestedTalkTrack?String(t.suggestedTalkTrack).substring(0,100):null,updateDealState:t.updateDealState||null};return i.NextResponse.json({success:!0,data:y,aiEnabled:!0,source:"ai"})}catch(e){return console.error("Error in live chat:",e),i.NextResponse.json({success:!1,error:e.message||"Failed to generate response"},{status:500})}}let g=new s.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/copilot/in-person/chat/route",pathname:"/api/copilot/in-person/chat",filename:"route",bundlePath:"app/api/copilot/in-person/chat/route"},resolvedPagePath:"C:\\dev\\Dealership Copilot\\app\\api\\copilot\\in-person\\chat\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:m,staticGenerationAsyncStorage:S,serverHooks:y}=g,I="/api/copilot/in-person/chat/route";function T(){return(0,o.patchFetch)({serverHooks:y,staticGenerationAsyncStorage:S})}},19692:(e,t,a)=>{a.d(t,{$:()=>i,f:()=>l});var r=a(67721),s=a(71615);let n="https://vabikejehdmpfcyqrgrs.supabase.co",o="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q";if(!n||!o){let e=[];throw n||e.push("NEXT_PUBLIC_SUPABASE_URL"),o||e.push("NEXT_PUBLIC_SUPABASE_ANON_KEY"),Error(`[CRITICAL] Missing required Supabase environment variables: ${e.join(", ")}. These must be set in Vercel environment variables.`)}if(n.includes("placeholder")||o.includes("placeholder"))throw Error("[CRITICAL] Supabase environment variables contain placeholder values. Please set real values in Vercel environment variables.");if(n.length<10||o.length<10)throw Error("[CRITICAL] Supabase environment variables appear to be invalid (too short). Please verify they are set correctly in Vercel.");function i(){let e=(0,s.cookies)();return(0,r.createServerClient)("https://vabikejehdmpfcyqrgrs.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZhYmlrZWplaGRtcGZjeXFyZ3JzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU0NzAzNDAsImV4cCI6MjA4MTA0NjM0MH0.X_Z7szu62swGviqYgtI2mxV3F1vX4UBYpuZYV2n7h4Q",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:a,options:r})=>{e.set(t,a,r)})}catch(e){}}}})}let l=i}};var t=require("../../../../../webpack-runtime.js");t.C(e);var a=e=>t(t.s=e),r=t.X(0,[8948,5972,7857,9702,4214],()=>a(99830));module.exports=r})();